
<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus & Filmtype Calculator</title>
    <!-- Font Awesome voor iconen -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-bg: #1a1a1a;
            --card-bg: #2d2d2d;
            --accent-color: #F5DF4D;
            --accent-hover: #e6c944;
            --text-color: #ffffff;
            --text-muted: #aaaaaa;
            --border-radius: 12px;
            --picker-height: 150px;
            --item-height: 50px;
        }

        body {
            font-family: 'Roboto Condensed', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overscroll-behavior-y: none;
        }

        .container {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            max-width: 500px;
            width: 100%;
            margin-top: 20px;
            position: relative;
        }

        /* Header & Navigatie */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #444;
            padding-bottom: 15px;
        }

        .home-icon {
            color: var(--text-color);
            font-size: 1.2rem;
            text-decoration: none;
            transition: color 0.3s;
        }

        .home-icon:hover {
            color: var(--accent-color);
        }

        h1 {
            color: var(--accent-color);
            margin: 0;
            font-size: 1.8rem;
            text-align: center;
            flex-grow: 1;
        }

        .info-btn {
            background: none;
            border: 2px solid var(--text-muted);
            color: var(--text-muted);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .info-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        /* Formulier Stijlen */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --- TAB STIJLEN --- */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: #333;
            border-radius: 8px;
            padding: 5px;
            gap: 5px;
            border: 1px solid #444;
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 10px;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
        }

        .tab-btn.active {
            background-color: var(--accent-color);
            color: #1a1a1a;
        }

        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Inputs */
        .input-row {
            display: flex;
            gap: 15px;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        input[type="number"] {
            width: 100%;
            padding: 12px;
            background-color: #3d3d3d;
            border: 1px solid #555;
            border-radius: 6px;
            color: white;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #3d3d3d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: border-color 0.3s;
        }
        
        .toggle-container:hover {
            border-color: #555;
        }

        .toggle-label {
            margin: 0;
            color: white;
            cursor: pointer;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
            background-color: #333; 
        }

        /* Keuze Secties (Focus & Filmtype) */
        .keuze-sectie {
            background-color: #333;
            padding: 15px;
            border-radius: 8px;
            margin-top: -10px;
            margin-bottom: 20px;
            border: 1px solid #444;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        /* Specifiek voor Focus inputs, zodat ze op de hoofdpagina niet dubbel ingekaderd lijken */
        #focus_keuze_wrapper {
            animation: fadeIn 0.3s ease-in-out;
            margin-top: -10px;
            margin-bottom: 10px;
        }

        .radio-group {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .radio-option input {
            margin-right: 8px;
            accent-color: var(--accent-color);
            transform: scale(1.2);
        }

        /* Bereken & Save Knop Container */
        .button-group {
            display: flex;
            gap: 10px;
        }

        .calculate-btn {
            flex: 1;
            background-color: var(--accent-color);
            color: #1a1a1a;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .save-btn {
            background-color: #444;
            color: var(--accent-color);
            width: 60px;
            font-size: 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .save-btn:hover {
            background-color: #555;
        }

        .calculate-btn:hover {
            background-color: var(--accent-hover);
            transform: translateY(-2px);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        /* Save Modal Specifiek */
        .save-option-group {
            margin-bottom: 15px;
            background: #333;
            padding: 10px;
            border-radius: 8px;
        }
        
        .save-option-group h4 {
            margin-top: 0;
            color: var(--accent-color);
            border-bottom: 1px solid #555;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .save-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .save-input-full {
            width: 100%;
        }
        
        select.modal-select {
            width: 100%;
            padding: 10px;
            background-color: #444;
            border: 1px solid #666;
            color: white;
            border-radius: 4px;
        }

        /* Saved Items List */
        #saved-list-container {
            margin-top: 40px;
            border-top: 1px solid #444;
            padding-top: 20px;
        }

        .saved-item-card {
            background-color: #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-color);
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .saved-item-card:hover {
            transform: translateX(5px);
            background-color: #3a3a3a;
        }

        .saved-item-title {
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }

        .saved-item-details {
            font-size: 0.85rem;
            color: #aaa;
        }

        .delete-saved-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #ff4444;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px;
        }
        
        .delete-saved-btn:hover {
            color: #ff6666;
        }

        /* Resultaat Sectie */
        #resultaat-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #3d3d3d;
            border-left: 5px solid var(--accent-color);
            border-radius: 4px;
            display: none;
            animation: slideUp 0.4s ease-out;
        }

        #resultaat-container h3 {
            margin-top: 0;
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        #resultaat-inhoud {
            font-size: 1.3rem;
            line-height: 1.6;
            color: white;
        }

        .tijd-highlight {
            color: var(--accent-color);
            font-weight: bold;
        }

        /* Nieuwe stijlen voor grote resultaat items */
        .big-result-item {
            font-size: 1.8rem;
            margin-bottom: 15px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #444;
        }
        
        .big-result-label {
            font-size: 1.5rem;
            color: var(--accent-color);
            font-weight: bold;
        }

        /* Modal */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.8); 
            backdrop-filter: blur(3px);
            overflow-y: auto; /* Enable scrolling if content is tall */
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 50px auto; /* Fixed top margin instead of % to prevent push-off */
            padding: 30px;
            border: 1px solid #444;
            width: 90%; /* Slightly wider on mobile */
            max-width: 500px;
            border-radius: var(--border-radius);
            position: relative;
            box-shadow: 0 0 20px rgba(245, 223, 77, 0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 0.8;
        }

        /* Animaties */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 400px) {
            .input-row {
                flex-direction: column;
                gap: 0;
            }
            .input-wrapper {
                margin-bottom: 15px;
            }
            .big-result-item {
                font-size: 1.5rem; /* Iets kleiner op hele smalle schermen */
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <a href="index.html" class="home-icon" title="Terug naar Home"><i class="fas fa-home"></i></a>
            <h1>FFD & Filmsoort</h1>
            <button class="info-btn" onclick="toggleModal('myModal')" title="Informatie">i</button>
        </div>

        <form id="calcForm" onsubmit="event.preventDefault(); bereken();">
            <!-- Tabs voor Invoer -->
            <div class="tabs">
                <button type="button" class="tab-btn active" onclick="switchTab('time')" id="btn-time">Tijd</button>
                <button type="button" class="tab-btn" onclick="switchTab('mamin')" id="btn-mamin">mA x min</button>
                <button type="button" class="tab-btn" onclick="switchTab('ci')" id="btn-ci">Ci Wissel</button>
            </div>

            <!-- TAB 1: Directe Tijd -->
            <div id="tab-time" class="tab-content">
                <div class="form-group">
                    <div class="input-row">
                        <div class="input-wrapper">
                            <label for="input_min">Minuten</label>
                            <input type="number" id="input_min" placeholder="0" min="0" inputmode="numeric">
                        </div>
                        <div class="input-wrapper">
                            <label for="input_sec">Seconden</label>
                            <input type="number" id="input_sec" placeholder="0" min="0" max="59" inputmode="numeric">
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: mA x min -->
            <div id="tab-mamin" class="tab-content" style="display:none;">
                <div class="form-group">
                    <div class="input-row">
                        <div class="input-wrapper">
                            <label for="input_mamin">mA * min</label>
                            <input type="number" id="input_mamin" placeholder="Bijv. 8" step="any" inputmode="decimal">
                        </div>
                        <div class="input-wrapper">
                            <label for="input_ma">Gebruikte mA</label>
                            <input type="number" id="input_ma" placeholder="Bijv. 3" step="any" inputmode="decimal">
                        </div>
                    </div>
                    <p style="font-size: 0.8rem; color: #888; text-align: center; margin-top: 5px; margin-bottom: 0;">
                        Tijd = (mA * min) / mA
                    </p>
                </div>
            </div>

            <!-- TAB 3: Ci Wissel -->
            <div id="tab-ci" class="tab-content" style="display:none;">
                <div class="form-group">
                    <label style="color: var(--accent-color); margin-bottom: 10px;">1. Oude Situatie</label>
                    <div class="input-row">
                        <div class="input-wrapper">
                            <label>Oude Tijd (Min)</label>
                            <input type="number" id="ci_old_min" placeholder="0" inputmode="numeric">
                        </div>
                        <div class="input-wrapper">
                            <label>(Sec)</label>
                            <input type="number" id="ci_old_sec" placeholder="0" inputmode="numeric">
                        </div>
                        <div class="input-wrapper">
                            <label>Oude Ci</label>
                            <input type="number" id="ci_old_val" placeholder="Bijv. 50" step="any" inputmode="decimal">
                        </div>
                    </div>

                    <label style="color: var(--accent-color); margin-top: 15px; margin-bottom: 10px;">2. Nieuwe Bron</label>
                    <div style="margin-bottom: 10px;">
                        <select id="ci_new_select" class="modal-select" onchange="onCiTabSourceSelect()">
                            <option value="manual">Handmatig invoeren...</option>
                            <option disabled>--- Uit Database ---</option>
                        </select>
                    </div>
                    <div class="input-wrapper">
                        <label>Nieuwe Ci</label>
                        <input type="number" id="ci_new_val" placeholder="Vul in of kies bron" step="any" inputmode="decimal">
                    </div>
                    
                    <p style="font-size: 0.8rem; color: #888; text-align: center; margin-top: 10px; margin-bottom: 0;">
                        Nieuwe Tijd = Oude Tijd * (Oude Ci / Nieuwe Ci)
                    </p>
                </div>
            </div>

            <!-- Focus Toggle -->
            <div class="toggle-container" onclick="toggleFocus()">
                <label class="toggle-label">Verandert de FFD?</label>
                <label class="switch">
                    <input type="checkbox" id="focus_veranderd" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <!-- Focus Invoer (Standaard zichtbaar) -->
            <div id="focus_keuze_wrapper">
                <div class="form-group">
                    <div class="input-row">
                        <div class="input-wrapper">
                            <label for="oude_focus">Oude Focus (FFD)</label>
                            <!-- Oude focus nu standaard op 80 -->
                            <input type="number" id="oude_focus" step="any" placeholder="Bijv. 80" value="80">
                        </div>
                        <div class="input-wrapper">
                            <label for="nieuwe_focus">Nieuwe Focus (FFD)</label>
                            <input type="number" id="nieuwe_focus" step="any" placeholder="Bijv. 100">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filmtype Toggle -->
            <div class="toggle-container" onclick="toggleFilmtype()">
                <label class="toggle-label">Verandert de Filmsoort?</label>
                <label class="switch">
                    <input type="checkbox" id="filmtype_veranderd">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- Filmtype Keuze (Verborgen) -->
            <div id="filmtype_keuze" class="keuze-sectie" style="display: none;">
                <label style="text-align:center; display:block;">Filmsoort van de BEGINTIJD:</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" id="D4" name="filmtype" value="D4" checked> 
                        <span>D4</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" id="D5" name="filmtype" value="D5"> 
                        <span>D5</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" id="D7" name="filmtype" value="D7"> 
                        <span>D7</span>
                    </label>
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="calculate-btn">
                    <i class="fas fa-calculator"></i> Bereken
                </button>
                <button type="button" class="save-btn" onclick="openSaveModal()" title="Opslaan">
                    <i class="fas fa-save"></i>
                </button>
            </div>
        </form>

        <!-- Resultaat -->
        <div id="resultaat-container">
            <h3>Resultaat</h3>
            <div id="resultaat-inhoud"></div>
        </div>
        
        <!-- Saved Items List -->
        <div id="saved-list-container">
            <h3 style="color: var(--text-muted); text-transform: uppercase; font-size: 0.9rem;">Opgeslagen Situaties</h3>
            <div id="saved-list">
                <div style="color: #666; font-style: italic;">Nog geen opgeslagen items...</div>
            </div>
        </div>
    </div>

    <!-- Save Modal -->
    <div id="saveModal" class="modal" onclick="if(event.target === this) toggleModal('saveModal')">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('saveModal')">&times;</span>
            <h2 style="color: var(--accent-color); margin-top:0;">Situatie Opslaan</h2>
            
            <div class="save-option-group">
                <h4>1. Bron Type</h4>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="saveSrcType" value="X-ray" onclick="toggleSaveFields()" checked> X-ray
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="saveSrcType" value="Se75" onclick="toggleSaveFields()"> Se75
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="saveSrcType" value="Ir192" onclick="toggleSaveFields()"> Ir192
                    </label>
                </div>
            </div>

            <!-- X-ray Fields -->
            <div id="save-xray-fields" class="save-option-group">
                <h4>Instellingen</h4>
                <div class="save-input-row">
                    <div class="input-wrapper">
                        <label>kV</label>
                        <input type="number" id="saveKv" placeholder="Bijv. 200" oninput="updateSummary()">
                    </div>
                    <div class="input-wrapper">
                        <label>mA</label>
                        <input type="number" id="saveMa" placeholder="Bijv. 5" oninput="updateSummary()">
                    </div>
                </div>
            </div>

            <!-- Gamma Fields -->
            <div id="save-gamma-fields" class="save-option-group" style="display:none;">
                <h4>Bron Selectie</h4>
                <div style="margin-bottom: 10px;">
                    <select id="saveSourceSelect" class="modal-select" onchange="onSaveSourceSelect()">
                        <option value="manual">Handmatig invoeren...</option>
                        <option disabled>--- Uit Database ---</option>
                    </select>
                </div>
                <div class="input-wrapper">
                    <label>Activiteit (Ci)</label>
                    <input type="number" id="saveCi" placeholder="Huidige Ci" step="0.01" oninput="updateSummary()">
                </div>
            </div>

            <!-- Common Fields -->
            <div class="save-option-group">
                <h4>Object & Film</h4>
                <div class="save-input-row">
                    <div class="input-wrapper">
                        <label>Dikte (mm)</label>
                        <input type="number" id="saveThickness" placeholder="Doorstraald" oninput="updateSummary()">
                    </div>
                    <div class="input-wrapper">
                        <label>Filmtype</label>
                        <select id="saveFilm" class="modal-select" onchange="updateSummary()">
                            <option value="D4">D4</option>
                            <option value="D5">D5</option>
                            <option value="D7">D7</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Summary & Confirm -->
            <div style="margin-top: 20px;">
                <label>Naam (aanpasbaar):</label>
                <input type="text" id="saveName" class="save-input-full" style="font-weight: bold; color: var(--accent-color);">
                
                <div style="margin-top: 10px; font-size: 0.85rem; color: #aaa;" id="saveContextSummary">
                    Context: ...
                </div>

                <button class="calculate-btn" style="margin-top: 15px;" onclick="saveCalculation()">
                    <i class="fas fa-check"></i> Opslaan
                </button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="myModal" class="modal" onclick="if(event.target === this) toggleModal('myModal')">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('myModal')">&times;</span>
            <h2 style="color: var(--accent-color); margin-top:0;">Hoe werkt het?</h2>
            <p><strong>1. Kies de Tijd:</strong> Stel de huidige belichtingstijd in.</p>
            <p><strong>2. Focus verandering (Optioneel):</strong> Als de afstand (FFD) verandert, zet de schakelaar aan en vul de afstanden in. De tool gebruikt de kwadratenwet: <code style="background:#444; padding: 2px 5px; border-radius:4px;">t2 = t1 * ((A2 / A1)^2)</code>.</p>
            <p><strong>3. Filmsoort verandering (Optioneel):</strong> Als je een ander type film gaat gebruiken (bijv. van D4 naar D5), zet deze optie aan om de geconverteerde tijden te zien.</p>
        </div>
    </div>

    <script>
        // --- Tab Logic ---
        let currentTab = 'time';

        // --- GLOBAL STATE FOR SAVING ---
        let csvSources = [];
        const STORAGE_KEY = 'rt_focus_saved_items_v1';

        // Load on startup
        document.addEventListener('DOMContentLoaded', async () => {
            renderSavedList();
            await loadCsvSources();
        });

        async function loadCsvSources() {
            try {
                const response = await fetch('bronnen.csv');
                const text = await response.text();
                const lines = text.trim().split('\n').slice(1); // skip header
                
                csvSources = lines.map(line => {
                    const cols = line.split(',');
                    if (cols.length < 4) return null;
                    return {
                        name: cols[0].trim(),
                        type: cols[1].trim(), // Ir192 or Se75
                        initialCi: parseFloat(cols[2]),
                        date: cols[3].trim() // DD-MM-YYYY
                    };
                }).filter(x => x);

                populateCiTabDropdown();

            } catch (e) {
                console.warn("CSV load failed", e);
            }
        }

        function populateCiTabDropdown() {
            const select = document.getElementById('ci_new_select');
            // Keep first two options
            select.innerHTML = '<option value="manual">Handmatig invoeren...</option><option disabled>--- Uit Database ---</option>';
            
            csvSources.forEach((src, idx) => {
                const currentCi = calculateCurrentCi(src.initialCi, src.type, src.date);
                const opt = document.createElement('option');
                opt.value = idx; 
                opt.text = `${src.type} ${src.name} (${currentCi.toFixed(2)} Ci)`;
                select.appendChild(opt);
            });
        }

        function onCiTabSourceSelect() {
            const idx = document.getElementById('ci_new_select').value;
            const ciInput = document.getElementById('ci_new_val');
            
            if (idx === 'manual') {
                ciInput.value = '';
                ciInput.readOnly = false;
                ciInput.style.backgroundColor = '#3d3d3d';
                ciInput.style.color = 'white';
            } else {
                const src = csvSources[idx];
                const currentCi = calculateCurrentCi(src.initialCi, src.type, src.date);
                ciInput.value = currentCi.toFixed(2);
                ciInput.readOnly = true;
                ciInput.style.backgroundColor = '#555'; 
                ciInput.style.color = '#ccc';
            }
        }

        // --- SAVE MODAL LOGIC ---
        function openSaveModal() {
            // Pre-fill "Old Focus" from main form if available
            // Note: We don't change inputs, just context
            updateSummary();
            toggleSaveFields(); // Ensure correct view
            toggleModal('saveModal');
        }

        function toggleSaveFields() {
            const type = document.querySelector('input[name="saveSrcType"]:checked').value;
            const xrayDiv = document.getElementById('save-xray-fields');
            const gammaDiv = document.getElementById('save-gamma-fields');
            const sourceSelect = document.getElementById('saveSourceSelect');
            
            if (type === 'X-ray') {
                xrayDiv.style.display = 'block';
                gammaDiv.style.display = 'none';
            } else {
                xrayDiv.style.display = 'none';
                gammaDiv.style.display = 'block';
                
                // Populate Select with relevant isotopes
                sourceSelect.innerHTML = '<option value="manual">Handmatig invoeren...</option><option disabled>--- Uit Database ---</option>';
                
                csvSources.forEach((src, idx) => {
                    if (src.type === type) {
                        const currentCi = calculateCurrentCi(src.initialCi, src.type, src.date);
                        const opt = document.createElement('option');
                        opt.value = idx; // Store index to retrieve full obj
                        opt.text = `${src.name} (${currentCi.toFixed(2)} Ci)`;
                        sourceSelect.appendChild(opt);
                    }
                });
            }
            updateSummary();
        }

        function onSaveSourceSelect() {
            const idx = document.getElementById('saveSourceSelect').value;
            const ciInput = document.getElementById('saveCi');
            
            if (idx === 'manual') {
                ciInput.value = '';
                ciInput.readOnly = false;
                ciInput.style.backgroundColor = '#3d3d3d';
                ciInput.style.color = 'white';
            } else {
                const src = csvSources[idx];
                const currentCi = calculateCurrentCi(src.initialCi, src.type, src.date);
                ciInput.value = currentCi.toFixed(2);
                ciInput.readOnly = true;
                ciInput.style.backgroundColor = '#555'; // Greyed out
                ciInput.style.color = '#ccc';
            }
            updateSummary();
        }

        function calculateCurrentCi(initialCi, type, dateStr) {
            const parts = dateStr.split('-');
            // JS Month is 0-indexed
            const srcDate = new Date(parts[2], parts[1] - 1, parts[0]);
            const today = new Date();
            const daysDiff = (today - srcDate) / (1000 * 60 * 60 * 24);
            const halfLife = (type === 'Se75') ? 120 : 74;
            return initialCi / Math.pow(2, daysDiff / halfLife);
        }

        function updateSummary() {
            // Gather Data
            const type = document.querySelector('input[name="saveSrcType"]:checked').value;
            const thick = document.getElementById('saveThickness').value || '?';
            const film = document.getElementById('saveFilm').value;
            
            // Get current context from Main App
            const oldFocus = document.getElementById('oude_focus').value || '?';
            
            // Calculate Time context
            let timeStr = "0s";
            if (currentTab === 'time') {
                const m = document.getElementById('input_min').value || 0;
                const s = document.getElementById('input_sec').value || 0;
                if (m>0 || s>0) timeStr = `${m}m ${s}s`;
            } else if (currentTab === 'mamin') {
                const mamin = document.getElementById('input_mamin').value;
                const ma = document.getElementById('input_ma').value;
                if(mamin && ma) {
                    const min = mamin/ma;
                    timeStr = `${Math.floor(min)}m ${Math.round((min%1)*60)}s`;
                }
            } else {
                 // Ci tab context... slightly harder but let's just use what's there
                 const m = document.getElementById('ci_old_min').value || 0;
                 const s = document.getElementById('ci_old_sec').value || 0;
                 timeStr = `${m}m ${s}s (Oud)`;
            }

            let sourceInfo = "";
            if (type === 'X-ray') {
                const kv = document.getElementById('saveKv').value || '?';
                const ma = document.getElementById('saveMa').value || '?';
                sourceInfo = `${kv}kV ${ma}mA`;
            } else {
                const ci = document.getElementById('saveCi').value || '?';
                sourceInfo = `${type} ${ci}Ci`;
            }

            // Update Name Field if user hasn't heavily customized it (simple check)
            // Or just always overwrite for prototype simplicity, 
            // but prompt said "allow user to ... change the default name".
            // We'll generate a default and set it only if empty or looks like a default.
            const newName = `[${sourceInfo}][${thick}mm][${film}]`;
            
            // Auto-update ONLY if currently empty or starts with [
            const nameInput = document.getElementById('saveName');
            if (nameInput.value === '' || nameInput.value.startsWith('[')) {
                nameInput.value = newName;
            }

            document.getElementById('saveContextSummary').innerText = 
                `Context: ${timeStr} op ${oldFocus} FFD (Oude Focus)`;
        }

        function saveCalculation() {
            // Get Data
            const name = document.getElementById('saveName').value;
            if (!name) return alert("Geef een naam op.");

            // Capture Main App State
            const oldFocus = document.getElementById('oude_focus').value;
            const film = document.getElementById('saveFilm').value; // Saved preference overrides main app?
            // "if they click it all the info should be filled ... change FFD and filmtype."
            // So we save the 'start' state.
            
            let timeData = {};
            if (currentTab === 'time') {
                timeData = {
                    type: 'time',
                    min: document.getElementById('input_min').value || 0,
                    sec: document.getElementById('input_sec').value || 0
                };
            } else if (currentTab === 'mamin') {
                timeData = {
                    type: 'mamin',
                    mamin: document.getElementById('input_mamin').value || 0,
                    ma: document.getElementById('input_ma').value || 0
                };
            } else {
                // Should we save "Ci Correction" state? 
                // Probably better to save the RESULTING time as 'time'.
                // But let's just save what we have. 
                // For simplicity, let's treat it as a Manual Time entry for now?
                // Or save specific data.
                timeData = {
                    type: 'ci',
                    oldMin: document.getElementById('ci_old_min').value || 0,
                    oldSec: document.getElementById('ci_old_sec').value || 0,
                    oldCi: document.getElementById('ci_old_val').value || 1,
                    newCi: document.getElementById('ci_new_val').value || 1
                };
            }

            const item = {
                id: Date.now(),
                name: name,
                oldFocus: oldFocus,
                startFilm: film, // The film type used for this exposure
                timeData: timeData,
                // Metadata for display/reference
                details: document.getElementById('saveContextSummary').innerText
            };

            // Save
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            saved.push(item);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));

            renderSavedList();
            toggleModal('saveModal');
        }

        function renderSavedList() {
            const list = document.getElementById('saved-list');
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            if (saved.length === 0) {
                list.innerHTML = '<div style="color: #666; font-style: italic;">Nog geen opgeslagen items...</div>';
                return;
            }

            list.innerHTML = '';
            saved.slice().reverse().forEach(item => { // Newest first
                const div = document.createElement('div');
                div.className = 'saved-item-card';
                div.onclick = (e) => loadSavedItem(item.id);
                
                div.innerHTML = `
                    <div class="saved-item-title">${item.name}</div>
                    <div class="saved-item-details">${item.details}</div>
                    <button class="delete-saved-btn" onclick="event.stopPropagation(); deleteSavedItem(${item.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function deleteSavedItem(id) {
            if(!confirm("Verwijderen?")) return;
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const newSaved = saved.filter(i => i.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(newSaved));
            renderSavedList();
        }

        function loadSavedItem(id) {
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const item = saved.find(i => i.id === id);
            if (!item) return;

            // Restore Fields
            document.getElementById('oude_focus').value = item.oldFocus;
            
            // Restore Tab & Time
            if (item.timeData.type === 'mamin') {
                switchTab('mamin');
                document.getElementById('input_mamin').value = item.timeData.mamin;
                document.getElementById('input_ma').value = item.timeData.ma;
            } else if (item.timeData.type === 'ci') {
                 switchTab('ci');
                 document.getElementById('ci_old_min').value = item.timeData.oldMin;
                 document.getElementById('ci_old_sec').value = item.timeData.oldSec;
                 document.getElementById('ci_old_val').value = item.timeData.oldCi;
                 document.getElementById('ci_new_val').value = item.timeData.newCi;
            } else {
                switchTab('time');
                document.getElementById('input_min').value = item.timeData.min;
                document.getElementById('input_sec').value = item.timeData.sec;
            }
            
            // Logic says "change default name if they want ...[Filmtype]". 
            // This implies the saved item HAS a filmtype associated (e.g. D4).
            // Main app has radio buttons for "Filmsoort van de BEGINTIJD".
            // We should set that radio.
            if (item.startFilm) {
                const radio = document.querySelector(`input[name="filmtype"][value="${item.startFilm}"]`);
                if (radio) {
                    radio.checked = true;
                    // Trigger any change logic if needed, but display logic handles checkbox
                }
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Optional: flash UI to indicate load?
            const container = document.querySelector('.container');
            container.style.boxShadow = '0 0 20px rgba(245, 223, 77, 0.5)';
            setTimeout(() => container.style.boxShadow = '0 10px 25px rgba(0,0,0,0.5)', 500);
        }

        function switchTab(tab) {
            currentTab = tab;
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + tab).classList.add('active');
            
            // Update content
            document.getElementById('tab-time').style.display = tab === 'time' ? 'block' : 'none';
            document.getElementById('tab-mamin').style.display = tab === 'mamin' ? 'block' : 'none';
            document.getElementById('tab-ci').style.display = tab === 'ci' ? 'block' : 'none';

            // Feature: Pre-fill Ci inputs if empty when switching
            if (tab === 'ci') {
                const oldM = document.getElementById('ci_old_min').value;
                const oldS = document.getElementById('ci_old_sec').value;
                if (!oldM && !oldS) {
                    // Try to get from Time Tab
                    const m = document.getElementById('input_min').value;
                    const s = document.getElementById('input_sec').value;
                    if (m || s) {
                        document.getElementById('ci_old_min').value = m || 0;
                        document.getElementById('ci_old_sec').value = s || 0;
                    }
                }
            }
        }

        // --- Hulpfuncties ---
        function tijdNaarSeconden(minuten, seconden) {
            return (minuten * 60) + seconden;
        }

        function secondenNaarTijd(totalSeconds) {
            const m = Math.floor(totalSeconds / 60);
            const s = Math.round(totalSeconds % 60); // Round to avoid .9999
            const sStr = s < 10 ? '0' + s : s;
            
            if (m > 0) {
                return `<span class="tijd-highlight">${m}m ${sStr}s</span>`;
            }
            return `<span class="tijd-highlight">${sStr}s</span>`;
        }

        // --- Helper voor Grote Resultaat Rijen ---
        function createBigResultRow(label, seconds) {
            return `
            <div class="big-result-item">
                <span class="big-result-label">${label}</span>
                <span>${secondenNaarTijd(seconds)}</span>
            </div>`;
        }

        // --- Toggle Logica ---
        function toggleFilmtype() {
            const checkbox = document.getElementById("filmtype_veranderd");
            setTimeout(() => {
                const keuzeDiv = document.getElementById('filmtype_keuze');
                keuzeDiv.style.display = checkbox.checked ? 'block' : 'none';
            }, 10);
        }

        function toggleFocus() {
            const checkbox = document.getElementById("focus_veranderd");
            setTimeout(() => {
                const keuzeDiv = document.getElementById('focus_keuze_wrapper');
                keuzeDiv.style.display = checkbox.checked ? 'block' : 'none';
            }, 10);
        }

        // Event listeners direct op inputs voor edge cases
        document.getElementById("filmtype_veranderd").addEventListener('change', function() {
            document.getElementById('filmtype_keuze').style.display = this.checked ? 'block' : 'none';
        });
        document.getElementById("focus_veranderd").addEventListener('change', function() {
            document.getElementById('focus_keuze_wrapper').style.display = this.checked ? 'block' : 'none';
        });

        // --- Berekeningen ---
        function berekenFocusverandering(begintijd, nieuweFocus, oudeFocus) {
            return begintijd * Math.pow(nieuweFocus / oudeFocus, 2);
        }

        function berekenD5D7VanD4(d4) {
            return { d5: d4 / 1.6666, d7: d4 / 2.44 };
        }

        function berekenD4D7VanD5(d5) {
            const d4 = d5 * 1.6666;
            return { d4: d4, d7: d4 / 2.44 };
        }

        function berekenD4D5VanD7(d7) {
            const d4 = d7 * 2.44;
            return { d4: d4, d5: d4 / 1.6666 };
        }

        // --- Hoofdfunctie ---
        function bereken() {
            let begintijdInSeconden = 0;
            let maminMsg = "";

            const resultContainer = document.getElementById("resultaat-container");
            const resultInhoud = document.getElementById("resultaat-inhoud");

            // Input Ophalen op basis van TAB
            if (currentTab === 'time') {
                const min = parseFloat(document.getElementById('input_min').value) || 0;
                const sec = parseFloat(document.getElementById('input_sec').value) || 0;
                
                if (min === 0 && sec === 0) {
                    toonFout(resultContainer, resultInhoud, "Vul a.u.b. een tijd in.");
                    return;
                }
                begintijdInSeconden = (min * 60) + sec;

            } else if (currentTab === 'mamin') {
                const mamin = parseFloat(document.getElementById('input_mamin').value);
                const ma = parseFloat(document.getElementById('input_ma').value);

                if (!mamin || !ma || ma === 0) {
                    toonFout(resultContainer, resultInhoud, "Vul geldige waarden in voor mA*min en mA.");
                    return;
                }
                
                // Bereken tijd: (mA*min) / mA = minuten
                const minutenDecimaal = mamin / ma;
                begintijdInSeconden = minutenDecimaal * 60;
                
                maminMsg = `<div style="font-size: 1rem; color: #ccc; margin-bottom: 10px; border-bottom: 1px solid #555; padding-bottom: 10px;">
                    ${mamin.toString()} mA*min, ${ma.toString()} mA gekozen = ${secondenNaarTijd(begintijdInSeconden)}
                </div>`;

            } else {
                // CI TAB
                const oldMin = parseFloat(document.getElementById('ci_old_min').value) || 0;
                const oldSec = parseFloat(document.getElementById('ci_old_sec').value) || 0;
                const oldCi = parseFloat(document.getElementById('ci_old_val').value);
                const newCi = parseFloat(document.getElementById('ci_new_val').value);

                if ((oldMin === 0 && oldSec === 0) || !oldCi || !newCi) {
                    toonFout(resultContainer, resultInhoud, "Vul alle Ci-velden en oude tijd in.");
                    return;
                }

                const oldTimeSec = (oldMin * 60) + oldSec;
                // New Time = Old Time * (Old Ci / New Ci)
                begintijdInSeconden = oldTimeSec * (oldCi / newCi);

                maminMsg = `<div style="font-size: 1rem; color: #ccc; margin-bottom: 10px; border-bottom: 1px solid #555; padding-bottom: 10px;">
                    Wissel van ${oldCi}Ci naar ${newCi}Ci<br>
                    ${secondenNaarTijd(oldTimeSec)} -> ${secondenNaarTijd(begintijdInSeconden)}
                </div>`;
            }
            
            const focusVeranderd = document.getElementById("focus_veranderd").checked;
            const filmtypeVeranderd = document.getElementById("filmtype_veranderd").checked;
            
            const nieuweFocus = parseFloat(document.getElementById("nieuwe_focus").value);
            const oudeFocus = parseFloat(document.getElementById("oude_focus").value);

            // 2. Als focus verandert, moeten de focusvelden geldig zijn
            if (focusVeranderd) {
                if (isNaN(nieuweFocus) || isNaN(oudeFocus) || oudeFocus === 0) {
                    toonFout(resultContainer, resultInhoud, "Vul geldige focus afstanden in.");
                    return;
                }
            }

            // Reset style (geel)
            resultContainer.style.display = "block";
            resultContainer.style.borderLeftColor = "#F5DF4D";

            // Stap 1: Focus Berekening
            let berekendeTijd = begintijdInSeconden;
            if (focusVeranderd) {
                berekendeTijd = berekenFocusverandering(begintijdInSeconden, nieuweFocus, oudeFocus);
            }

            let outputHTML = maminMsg; // Start met mA info indien van toepassing

            // Stap 2: Resultaat opbouwen
            if (focusVeranderd && !filmtypeVeranderd) {
                // Scenario A: Alleen Focus verandert
                outputHTML += `Op <strong>${nieuweFocus} FFD</strong> is de stralingstijd:<br>`;
                outputHTML += `<div style="font-size: 2rem; margin-top: 10px;">${secondenNaarTijd(berekendeTijd)}</div>`;
            } 
            else if (!focusVeranderd && !filmtypeVeranderd) {
                // Scenario B: Niets verandert
                // Als mA*min tab is gebruikt, is de info al getoond in maminMsg.
                // We voegen nog een bevestiging toe of als het Time tab was:
                if (currentTab === 'time') {
                    outputHTML += "Je hebt geen veranderingen geselecteerd.<br>De tijd blijft: " + secondenNaarTijd(begintijdInSeconden);
                } else {
                     // Voor mA*min is de bovenstaande msg genoeg, maar misschien duidelijkheid:
                     outputHTML += "Geen verdere aanpassingen (Focus/Film).";
                }
            }
            else {
                // Scenario C: Filmtype verandert (en mogelijk ook focus)
                const filmtype = document.querySelector('input[name="filmtype"]:checked').value;
                
                if (focusVeranderd) {
                     outputHTML += `Op <strong>${nieuweFocus} FFD</strong> is de tijd bij wissel van <strong>${filmtype}</strong> naar:<br>`;
                } else {
                     outputHTML += `Bij wissel van <strong>${filmtype}</strong> naar:<br>`;
                }
               
                outputHTML += `<div style="margin-top:20px;">`; // Container voor blokken

                if (filmtype === "D4") {
                    const res = berekenD5D7VanD4(berekendeTijd);
                    outputHTML += createBigResultRow("D5", res.d5);
                    outputHTML += createBigResultRow("D7", res.d7);
                } else if (filmtype === "D5") {
                    const res = berekenD4D7VanD5(berekendeTijd);
                    outputHTML += createBigResultRow("D4", res.d4);
                    outputHTML += createBigResultRow("D7", res.d7);
                } else if (filmtype === "D7") {
                    const res = berekenD4D5VanD7(berekendeTijd);
                    outputHTML += createBigResultRow("D4", res.d4);
                    outputHTML += createBigResultRow("D5", res.d5);
                }
                outputHTML += `</div>`;
            }

            resultInhoud.innerHTML = outputHTML;
            resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function toonFout(container, inhoud, bericht) {
            container.style.display = "block";
            container.style.borderLeftColor = "#ff4444";
            inhoud.innerHTML = `<span style='color:#ff4444'>${bericht}</span>`;
            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function toggleModal(id) {
            const modal = document.getElementById(id);
            modal.style.display = (modal.style.display === "block") ? "none" : "block";
        }
    </script>
</body>
</html>
