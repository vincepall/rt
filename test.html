<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Smarter Local OCR</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; max-width: 900px; margin: 30px auto; background: #f8fafc; color: #1e293b; }
        .card { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .header { text-align: center; margin-bottom: 2rem; }
        .upload-zone { border: 2px dashed #cbd5e1; padding: 2rem; border-radius: 0.75rem; text-align: center; cursor: pointer; transition: 0.3s; background: #f1f5f9; }
        .upload-zone:hover { border-color: #3b82f6; background: #eff6ff; }
        
        /* De 'Schoonmaak' status */
        .processing-steps { display: flex; gap: 10px; margin: 1rem 0; font-size: 0.85rem; color: #64748b; }
        .step { padding: 5px 10px; border-radius: 4px; background: #e2e8f0; }
        .step.active { background: #3b82f6; color: white; }

        .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 2rem; }
        .text-list { display: flex; flex-direction: column; gap: 8px; }
        .segment { 
            background: white; border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; 
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            font-size: 0.95rem; transition: 0.2s;
        }
        .segment:hover { border-color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .segment-text { font-family: 'Consolas', monospace; font-weight: 600; }
        
        canvas { display: none; } /* Onzichtbaar filter canvas */
        #preview { width: 100%; border-radius: 8px; margin-top: 10px; display: none; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: #10b981; color: white; padding: 12px 24px; border-radius: 8px; display: none; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateY(100px); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <h2>Slimme Tekst Scanner</h2>
        <p>Beeld wordt eerst lokaal geoptimaliseerd voor betere herkenning.</p>
    </div>

    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
        <strong>Sleep hier een foto</strong> of klik om te bladeren
        <input type="file" id="fileInput" accept="image/*" style="display:none">
    </div>

    <div class="processing-steps">
        <span id="step1" class="step">1. Optimaliseren</span>
        <span id="step2" class="step">2. OCR Scan</span>
        <span id="step3" class="step">3. Filteren</span>
    </div>

    <img id="preview" alt="Voorbeeld">
    <canvas id="filterCanvas"></canvas>

    <div class="result-grid">
        <div class="text-list" id="segments">
            </div>
        <div id="sideInfo" style="font-size: 0.8rem; color: #64748b;">
            <p><strong>Tip:</strong> Klik op een waarde om deze direct te kopiÃ«ren naar je rapportage.</p>
            <div id="stats"></div>
        </div>
    </div>
</div>

<div id="toast" class="toast">Gekopieerd!</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const segmentsContainer = document.getElementById('segments');
    const canvas = document.getElementById('filterCanvas');
    const ctx = canvas.getContext('2d');

    fileInput.onchange = (e) => processImage(e.target.files[0]);

    async function processImage(file) {
        if (!file) return;
        
        // Stap 1: Beeld optimaliseren
        setStep(1);
        const img = new Image();
        img.src = URL.createObjectURL(file);
        
        img.onload = async () => {
            // Teken afbeelding op canvas voor bewerking
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            // Pas filters toe: Grijswaarden en Contrast verhogen
            preprocessImage();
            
            const processedDataUrl = canvas.toDataURL('image/jpeg', 1.0);
            document.getElementById('preview').src = processedDataUrl;
            document.getElementById('preview').style.display = 'block';

            // Stap 2: OCR op het 'schone' beeld
            setStep(2);
            const result = await Tesseract.recognize(processedDataUrl, 'nld+eng');
            
            // Stap 3: Filteren van de ruis
            setStep(3);
            cleanAndDisplay(result.data.text);
        };
    }

    function preprocessImage() {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        for (let i = 0; i < data.length; i += 4) {
            // Maak grijswaarden
            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
            
            // Verhoog contrast (thresholding)
            // Alles lichter dan 130 wordt wit, de rest zwart
            const v = (avg > 128) ? 255 : 0;
            
            data[i] = data[i+1] = data[i+2] = v;
        }
        ctx.putImageData(imageData, 0, 0);
    }

    function cleanAndDisplay(rawText) {
        segmentsContainer.innerHTML = "";
        const lines = rawText.split('\n')
            .map(line => line.trim())
            .filter(line => {
                // Verwijder regels die te kort zijn of alleen maar symbolen bevatten
                return line.length > 2 && /[a-zA-Z0-9]/.test(line);
            });

        lines.forEach(line => {
            const div = document.createElement('div');
            div.className = 'segment';
            div.onclick = () => copyText(line);
            div.innerHTML = `<span class="segment-text">${line}</span><small style="color:#3b82f6">COPY</small>`;
            segmentsContainer.appendChild(div);
        });
        
        setStep(0); // Reset status
        document.getElementById('stats').innerText = `Gevonden fragmenten: ${lines.length}`;
    }

    function setStep(stepNr) {
        document.querySelectorAll('.step').forEach((s, i) => {
            s.className = (i + 1 === stepNr) ? 'step active' : 'step';
        });
    }

    function copyText(text) {
        navigator.clipboard.writeText(text);
        const toast = document.getElementById('toast');
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 2000);
    }
</script>

</body>
</html>
