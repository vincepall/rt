<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Snipper Pro - Rotatie & Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: #333; }
        
        /* Toolbar bovenaan */
        .toolbar { background: #fff; padding: 10px; display: flex; gap: 10px; align-items: center; border-bottom: 2px solid #000; z-index: 100; }
        
        /* De container voor het document */
        .viewport { flex: 1; overflow: auto; position: relative; padding: 20px; display: flex; justify-content: center; }
        
        .canvas-container { position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); background: white; height: fit-content; }
        
        canvas { display: block; cursor: crosshair; }
        
        /* Selectie kader */
        #selection-box { 
            position: absolute; border: 2px solid #007bff; background: rgba(0, 123, 255, 0.2); 
            display: none; pointer-events: none; z-index: 50;
        }

        /* Resultaat balk onderaan */
        .footer { background: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-top: 2px solid #000; }
        #ocr-output { font-family: monospace; font-size: 1.2rem; font-weight: bold; color: #007bff; }
        .btn { padding: 8px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        .btn-secondary { background: #6c757d; }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="file" id="file-input" accept="image/*,application/pdf">
    <button class="btn btn-secondary" onclick="rotateDocument()">ðŸ”„ Draaien</button>
    <span id="status" style="font-size: 0.8em;">Kies een bestand</span>
</div>

<div class="viewport">
    <div class="canvas-container" id="container">
        <canvas id="main-canvas"></canvas>
        <div id="selection-box"></div>
    </div>
</div>

<div class="footer">
    <div>Gescand: <span id="ocr-output">...</span></div>
    <button class="btn" onclick="copyText()">Kopieer</button>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('container');
    const selectionBox = document.getElementById('selection-box');
    const ocrOutput = document.getElementById('ocr-output');
    
    let currentRotation = 0;
    let currentFile = null;
    let isDrawing = false;
    let startX, startY;

    // --- BESTANDSVERWERKING ---
    document.getElementById('file-input').onchange = (e) => {
        currentFile = e.target.files[0];
        currentRotation = 0;
        loadFile();
    };

    async function loadFile() {
        if (!currentFile) return;
        document.getElementById('status').innerText = "Laden...";

        if (currentFile.type === "application/pdf") {
            const arrayBuffer = await currentFile.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            const page = await pdf.getPage(1);
            
            // Gebruik rotatie instelling
            const viewport = page.getViewport({ scale: 2.0, rotation: currentRotation });
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
        } else {
            const img = new Image();
            img.onload = () => {
                // Afbeelding draaien op canvas
                if (currentRotation % 180 !== 0) {
                    canvas.width = img.height;
                    canvas.height = img.width;
                } else {
                    canvas.width = img.width;
                    canvas.height = img.height;
                }
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate((currentRotation * Math.PI) / 180);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                ctx.restore();
            };
            img.src = URL.createObjectURL(currentFile);
        }
        document.getElementById('status').innerText = "Gereed. Trek een kader.";
    }

    function rotateDocument() {
        currentRotation = (currentRotation + 90) % 360;
        loadFile();
    }

    // --- COÃ–RDINATEN EN SELECTIE ---
    // Gebruik de container voor muis-events om scroll-fouten te voorkomen
    container.onmousedown = (e) => {
        if (e.target !== canvas && e.target !== selectionBox) return;
        isDrawing = true;
        
        // layerX/Y geeft de positie relatief aan de container
        startX = e.layerX;
        startY = e.layerY;

        selectionBox.style.left = startX + "px";
        selectionBox.style.top = startY + "px";
        selectionBox.style.width = "0px";
        selectionBox.style.height = "0px";
        selectionBox.style.display = "block";
    };

    container.onmousemove = (e) => {
        if (!isDrawing) return;
        
        const currentX = e.layerX;
        const currentY = e.layerY;

        const width = currentX - startX;
        const height = currentY - startY;

        selectionBox.style.width = Math.abs(width) + "px";
        selectionBox.style.height = Math.abs(height) + "px";
        selectionBox.style.left = (width < 0 ? currentX : startX) + "px";
        selectionBox.style.top = (height < 0 ? currentY : startY) + "px";
    };

    window.onmouseup = async (e) => {
        if (!isDrawing) return;
        isDrawing = false;

        const rect = selectionBox.getBoundingClientRect();
        const canvRect = canvas.getBoundingClientRect();

        // Bereken de schaling tussen scherm-pixels en canvas-pixels
        const scaleX = canvas.width / canvRect.width;
        const scaleY = canvas.height / canvRect.height;

        const x = (rect.left - canvRect.left) * scaleX;
        const y = (rect.top - canvRect.top) * scaleY;
        const w = rect.width * scaleX;
        const h = rect.height * scaleY;

        if (w > 5 && h > 5) {
            doOCR(x, y, w, h);
        }
    };

    async function doOCR(x, y, w, h) {
        ocrOutput.innerText = "Bezig...";
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = w;
        tempCanvas.height = h;
        const tempCtx = tempCanvas.getContext('2d');
        
        tempCtx.drawImage(canvas, x, y, w, h, 0, 0, w, h);

        const result = await Tesseract.recognize(tempCanvas.toDataURL(), 'nld+eng');
        const text = result.data.text.trim();
        ocrOutput.innerText = text || "[Geen tekst]";
        if(text) navigator.clipboard.writeText(text);
    }

    function copyText() {
        navigator.clipboard.writeText(ocrOutput.innerText);
        alert("Gekopieerd!");
    }
</script>

</body>
</html>
