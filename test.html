<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gecombineerde Tool</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <a href="index.html" class="home-icon"><i class="fas fa-home"></i></a>
    <style>
        .form-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 10px auto;
            max-width: 600px;
        }
        .form-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .form-item label {
            min-width: 200px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-item input,
        .form-item select {
            flex: 1;
            padding: 8px;
            width: 100%;
            min-width: 200px;
            box-sizing: border-box;
        }
        .submit-btn {
            background-color: #F5DF4D;
            color: black;
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            display: block;
            margin: 20px auto;
            width: 100%;
            max-width: 400px;
        }
        .image-container {
            position: relative;
            background-size: cover;
            border: 1px solid black;
            margin: 20px auto;
        }
        .crosshair {
            position: absolute;
            width: 30px;
            height: 30px;
            left: 0;
            top: 0;
            pointer-events: none;
        }

        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background-color: rgb(255, 49, 49);
        }

        .crosshair::before { top: 14px; left: 0; width: 30px; height: 2px; }
        .crosshair::after { left: 14px; top: 0; width: 2px; height: 30px; }

        .highlight-circle {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(0, 0, 128, 0.2);
            left: -10px;
            top: -10px;
            pointer-events: none;
        }
        #wire-result {
            color: yellow;
        }
        #container1A h2,
        #container2A h2,
        #container1B h2,
        #container2B h2 {
            color: red;
        }
        #results-section {
            scroll-margin-top: 20px;
        }
        .ffd-warning {
            color: red;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background-color: rgba(255, 0, 0, 0.1);
            border-radius: 5px;
            display: none;
        }
        .diameter-warning {
            color: orange;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background-color: rgba(255, 165, 0, 0.1);
            border-radius: 5px;
            display: none;
        }
        .red-text {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Gecombineerde Tool</h1>

    <div class="form-container">
        <div class="form-item">
            <label for="procedure">Kies de procedure:</label>
            <select id="procedure" name="procedure" required>
                <option value="" disabled selected>Selecteer procedure</option>
                <option value="EN-A">EN-Klasse A</option>
                <option value="EN-B">EN-Klasse B</option>
                <option value="ASME">ASME</option>
            </select>
        </div>
        <div class="form-item">
            <label for="diameter">Diameter (De) in mm:</label>
            <input type="number" id="diameter" name="diameter" step="0.01" required>
        </div>
        <div class="form-item">
            <label for="wanddikte">Wanddikte (t) in mm:</label>
            <input type="number" id="wanddikte" name="wanddikte" step="0.01" required>
        </div>
        <div id="enOptions" style="display:none;">
            <div class="form-item">
                <label for="technique">Opstelling:</label>
                <select id="technique" name="technique">
                    <option value="SWSI">SWSI</option>
                    <option value="DWSI">DWSI</option>
                    <option value="DWDI">DWDI</option>
                </select>
            </div>
            <div class="form-item">
                <label for="source">Stralingsbron:</label>
                <select id="source" name="source">
                    <option value="X-ray">X-ray</option>
                    <option value="Se75">Se-75</option>
                    <option value="Ir192">Ir-192</option>
                </select>
            </div>
            <div class="form-item" id="enBSubProcedureDiv" style="display:none;">
                <label for="enBSubProcedure">EN-B Sub-procedure:</label>
                <select id="enBSubProcedure" name="enBSubProcedure">
                    <option value="RT21013">RT21013 EN-B</option>
                    <option value="RT16172">RT16172 Sabic</option>
                    <option value="RT14171">RT14171 Sitech</option>
                    <option value="RT20230059">RT 2023 0059 Haffmans</option>
                </select>
            </div>
            <div class="form-item" id="ovenMateriaalDiv" style="display:none;">
                <label for="ovenMateriaal">Ovenmateriaal:</label>
                <select id="ovenMateriaal" name="ovenMateriaal">
                    <option value="Nee">Nee</option>
                    <option value="Ja">Ja</option>
                </select>
            </div>
             <div class="form-item" id="optieDiv" style="display:none;">
                <label for="optie">Centraal of Excentrisch:</label>
                <select id="optie" name="optie">
                    <option value="">Nee</option>
                    <option value="1">Centraal</option>
                    <option value="2">Excentrisch</option>
                </select>
            </div>
            <div class="form-item" id="ovaaltjeDiv" style="display:none;">
                <label for="ovaaltje">Ovaaltje:</label>
                <select id="ovaaltje" name="ovaaltje">
                    <option value="Nee">Nee</option>
                    <option value="Ja">Ja</option>
                </select>
            </div>
            <div class="form-item" id="lasbreedteDiv" style="display:none;">
                <label for="lasbreedte">Lasbreedte (mm):</label>
                <input type="number" id="lasbreedte" name="lasbreedte" step="0.01">
            </div>
        </div>
        <div class="form-item">
            <label for="brongrootte">Brongrootte in mm:</label>
            <input type="text" id="brongrootte" name="brongrootte" list="bronKeuzes" required placeholder="Kies of vul in (mm)">
            <datalist id="bronKeuzes">
            </datalist>
        </div>
        <div class="form-item">
            <label for="ofa">Object Film Afstand (OFA) in mm:</label>
            <input type="number" id="ofa" name="ofa" step="0.01" required>
        </div>
        <div class="form-item">
            <label for="sfd">Bron Film Afstand (FFD) in mm:</label>
            <input type="number" id="sfd" name="sfd" step="0.01" required>
            <span id="ffd-warning" style="color: red; margin-left: 10px;"></span>
        </div>
        <div id="asmeOptions" style="display:none;">
            <div class="form-item">
                <label for="asmeTechnique">Plaats van de BKI:</label>
                <select id="asmeTechnique" name="asmeTechnique">
                    <option value="Sourceside">BKI bronzijde</option>
                    <option value="Filmside">BKI Filmzijde</option>
                </select>
            </div>
            <div class="form-item">
                <label for="weldType">Lastype:</label>
                <select id="weldType" name="weldType">
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
            </div>
        </div>

        <button type="button" class="submit-btn" onclick="calculate()">Bereken</button>
    </div>

    <div id="results-section">
        <h2>Resultaten</h2>
        <div class="diameter-warning" id="diameter-warning"></div>
        <div class="ffd-warning" id="ffd-result-warning"></div>
        <p id="wire-result"></p>
        <p id="min-ffd-result" style="color: yellow;"></p>
        <p id="film-quality-result" style="color: yellow;"></p>
        <p id="verzet-result" style="color: yellow;"></p>

        <div id="diameterAntwoord" style="display: none; text-align: center; margin: 20px;">
            <strong style="font-size: 1.3em; color: yellow; padding: 15px;">
                Aantal opnames: 2 bij opstelling 11/F , 3 bij opstelling 12/G
            </strong>
        </div>

        <div class="image-container" id="container1B" style="display: none; width: 488px; height: 819px; background-image: url('klasseb2.png');">
          <h2>Opstelling 5/8/13/14 (Klasse B)</h2>
        </div>
        <div class="image-container" id="container2B" style="display: none; width: 488px; height: 823px; background-image: url('klasseb1.png');">
          <h2>Opstelling 2 (Klasse B)</h2>
        </div>
        <div class="image-container" id="container1A" style="display: none; width: 487px; height: 823px; background-image: url('opstelling13klassea.png');">
          <h2>Opstelling 5/8/13/14 (Klasse A)</h2>
        </div>
        <div class="image-container" id="container2A" style="display: none; width: 470px; height: 796px; background-image: url('opstelling2klassea.png');">
          <h2>Opstelling 2 (Klasse A)</h2>
        </div>
    </div>

    <script>
        let bronnenData = [];
        let minFFD = 0;

        // Add event listeners to all relevant inputs for auto-update
        ["procedure", "diameter", "wanddikte", "brongrootte", "ofa", "technique", "source", "optie", "asmeTechnique", "weldType", "ovaaltje", "lasbreedte"].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener("input", autoCalculate);
                element.addEventListener("change", autoCalculate);
            }
        });

        // Add separate listener for manual FFD changes
        document.getElementById("sfd").addEventListener("input", function() {
            checkFFDWarning();
            autoCalculate();
        });

        document.getElementById("source").addEventListener("change", updateBronGrootteOptions);

        document.getElementById("optie").addEventListener("change", autoCalculate);

        document.getElementById("enBSubProcedure").addEventListener("change", function() {
            const enBSubProcedure = this.value;
            const ovenMateriaalDiv = document.getElementById("ovenMateriaalDiv");
            if (enBSubProcedure === "RT16172") {
                ovenMateriaalDiv.style.display = "flex";
            } else {
                ovenMateriaalDiv.style.display = "none";
            }
            autoCalculate();
        });

        document.getElementById("ovaaltje").addEventListener("change", function() {
            const ovaaltje = this.value;
            const lasbreedteDiv = document.getElementById("lasbreedteDiv");
            if (ovaaltje === "Ja") {
                lasbreedteDiv.style.display = "flex";
            } else {
                lasbreedteDiv.style.display = "none";
            }
            autoCalculate();
        });

        function updateBronGrootteOptions() {
            const procedure = document.getElementById("procedure").value;
            const source = document.getElementById("source").value;
            const bronKeuzesDatalist = document.getElementById("bronKeuzes");
            bronKeuzesDatalist.innerHTML = '';

            if (procedure === "ASME") {
                bronnenData.forEach(bron => {
                    const option = document.createElement('option');
                    option.value = bron.label;
                    bronKeuzesDatalist.appendChild(option);
                });
                bronKeuzesDatalist.innerHTML += `
                    <option value="Yxlon (3 mm)"></option>
                    <option value="Yxlon Smart (1 mm)"></option>
                    <option value="Balteau (2.5 mm)"></option>
                `;
            } else if (source === 'X-ray') {
                bronKeuzesDatalist.innerHTML = `
                    <option value="Yxlon (3 mm)"></option>
                    <option value="Yxlon Smart (1 mm)"></option>
                    <option value="Balteau (2.5 mm)"></option>
                `;
            } else {
                const filteredBronnen = bronnenData.filter(b => b.type === source);
                filteredBronnen.forEach(bron => {
                    const option = document.createElement('option');
                    option.value = bron.label;
                    bronKeuzesDatalist.appendChild(option);
                });
            }
        }

        function handleDiameterTechniqueRestriction() {
            const procedure = document.getElementById("procedure").value;
            const diameter = parseFloat(document.getElementById("diameter").value);
            const techniqueSelect = document.getElementById("technique");
            const swsiOption = techniqueSelect.querySelector('option[value="SWSI"]');
            const dwsiOption = techniqueSelect.querySelector('option[value="DWSI"]');
            const dwdiOption = techniqueSelect.querySelector('option[value="DWDI"]');

            if (isNaN(diameter) || (procedure !== "EN-A" && procedure !== "EN-B")) {
                if (swsiOption) swsiOption.disabled = false;
                if (dwsiOption) dwsiOption.disabled = false;
                if (dwdiOption) dwdiOption.disabled = false;
                return;
            }

            // CHANGE 1: Force DWDI when diameter < 100
            if (diameter < 100) {
                if (techniqueSelect.value !== "DWDI") {
                    techniqueSelect.value = "DWDI";
                }
                if (swsiOption) swsiOption.disabled = true;
                if (dwsiOption) dwsiOption.disabled = true;
                if (dwdiOption) dwdiOption.disabled = false;
            } else {
                if (techniqueSelect.value === "DWDI") {
                    techniqueSelect.value = "SWSI";
                }
                if (swsiOption) swsiOption.disabled = false;
                if (dwsiOption) dwsiOption.disabled = false;
                if (dwdiOption) dwdiOption.disabled = true;
            }
            autoCalculate();
        }

        function autoCalculate() {
            handleCentraalAutoFill();
            handleDiameterTechniqueRestriction();
            updateOFA();
            updateFFD();
            calculateResults();
        }

        function updateOFA() {
            const procedure = document.getElementById("procedure").value;
            const diameter = parseFloat(document.getElementById("diameter").value);
            const wanddikte = parseFloat(document.getElementById("wanddikte").value);
            const ofaInput = document.getElementById("ofa");
            const technique = document.getElementById("technique").value;

            if (isNaN(diameter) || isNaN(wanddikte)) {
                return;
            }

            if (procedure === "ASME") {
                if (diameter < 100) {
                    ofaInput.value = diameter.toFixed(2);
                } else {
                    ofaInput.value = wanddikte.toFixed(2);
                }
            } else if ((procedure === "EN-A" || procedure === "EN-B") && technique === "DWDI" && diameter < 100) {
                ofaInput.value = diameter.toFixed(2);
            } else if (technique === "SWSI" || technique === "DWSI") {
                ofaInput.value = wanddikte.toFixed(2);
            } else if (technique === "DWDI") {
                ofaInput.value = diameter.toFixed(2);
            }
        }

        function updateFFD() {
            calculateMinFFD();
            // CHANGE 2: Auto-fill FFD field if empty
            const sfdInput = document.getElementById("sfd");
            if (!sfdInput.value || sfdInput.value === "") {
                sfdInput.value = minFFD.toFixed(2);
            }
            checkFFDWarning();
        }

        function calculateMinFFD() {
            const procedure = document.getElementById("procedure").value;
            const diameter = parseFloat(document.getElementById("diameter").value);
            const wanddikte = parseFloat(document.getElementById("wanddikte").value);
            const brongrootteValue = document.getElementById("brongrootte").value;
            const ofa = parseFloat(document.getElementById("ofa").value);
            const source = document.getElementById("source").value;
            const optie = document.getElementById("optie").value;
            const centraal = optie === '1';
            const excentrisch = optie === '2';

            let brongrootte = 0;
            if (brongrootteValue.includes("Yxlon (3 mm)")) brongrootte = 3;
            else if (brongrootteValue.includes("Yxlon Smart (1 mm)")) brongrootte = 1;
            else if (brongrootteValue.includes("Balteau (2.5 mm)")) brongrootte = 2.5;
            else {
                 const bron = bronnenData.find(b => b.label === brongrootteValue);
                 brongrootte = bron ? bron.size : parseFloat(brongrootteValue);
            }

            if (isNaN(diameter) || isNaN(wanddikte) || isNaN(brongrootte) || isNaN(ofa)) {
                return;
            }

            let ffd = 0;
            if (procedure === "ASME") {
                if (wanddikte < 50) ffd = (brongrootte * ofa) / 0.51 + ofa;
                else if (wanddikte < 75) ffd = (brongrootte * ofa) / 0.76 + ofa;
                else if (wanddikte <= 100) ffd = (brongrootte * ofa) / 1.02 + ofa;
                else {
                    document.getElementById("ffd-warning").innerText = "Wanddikte te groot voor ASME berekening.";
                    return;
                }
            } else {
                let factor = (procedure === "EN-A") ? 7.5 : 15;
                let basis = brongrootte * factor * Math.pow(ofa, 2 / 3);
                if (centraal) basis *= 0.5;
                if (excentrisch) basis *= 0.8;
                ffd = basis + ofa;
            }

            minFFD = ffd;
            checkFFDWarning();
        }

        function checkFFDWarning() {
            const userFFD = parseFloat(document.getElementById("sfd").value);
            if (!isNaN(userFFD) && !isNaN(minFFD) && userFFD < minFFD) {
                document.getElementById("ffd-warning").innerText = `Waarschuwing: FFD is lager dan het minimum van ${minFFD.toFixed(2)} mm`;
            } else {
                document.getElementById("ffd-warning").innerText = "";
            }
        }

        document.getElementById("procedure").addEventListener("change", function() {
            var procedure = document.getElementById("procedure").value;
            var enBSubProcedureDiv = document.getElementById("enBSubProcedureDiv");
            var ovenMateriaalDiv = document.getElementById("ovenMateriaalDiv");

            if (procedure === "EN-A" || procedure === "EN-B") {
                document.getElementById("enOptions").style.display = "block";
                document.getElementById("asmeOptions").style.display = "none";
                if (procedure === "EN-B") {
                    enBSubProcedureDiv.style.display = "flex";
                    ovenMateriaalDiv.style.display = "none";
                } else {
                    enBSubProcedureDiv.style.display = "none";
                    ovenMateriaalDiv.style.display = "none";
                }
            } else {
                document.getElementById("enOptions").style.display = "none";
                document.getElementById("asmeOptions").style.display = "block";
                enBSubProcedureDiv.style.display = "none";
                ovenMateriaalDiv.style.display = "none";
                updateBronGrootteOptions();
            }
            handleDiameterTechniqueRestriction();
            autoCalculate();
        });

        document.getElementById("technique").addEventListener("change", function() {
            const technique = this.value;
            const ofaInput = document.getElementById("ofa");
            const wanddikte = parseFloat(document.getElementById("wanddikte").value);
            const diameter = parseFloat(document.getElementById("diameter").value);
            const optieDiv = document.getElementById("optieDiv");
            const ovaaltjeDiv = document.getElementById("ovaaltjeDiv");
            const lasbreedteDiv = document.getElementById("lasbreedteDiv");

            if (technique === "SWSI" || technique === "DWSI") {
                ofaInput.value = wanddikte;
                optieDiv.style.display = "flex";
                ovaaltjeDiv.style.display = "none";
                lasbreedteDiv.style.display = "none";
            } else if (technique === "DWDI") {
                ofaInput.value = diameter;
                optieDiv.style.display = "none";
                ovaaltjeDiv.style.display = "flex";
                lasbreedteDiv.style.display = "none";
            }
            autoCalculate();
        });

        document.getElementById("brongrootte").addEventListener("input", function() {
            const selectedLabel = this.value;
            const sourceSelect = document.getElementById("source");
            const procedure = document.getElementById("procedure").value;

            if (procedure !== "ASME") {
                if (selectedLabel.toLowerCase().includes('yxlon') || selectedLabel.toLowerCase().includes('balteau')) {
                    sourceSelect.value = 'X-ray';
                    return;
                }

                const bron = bronnenData.find(b => b.label === selectedLabel);

                if (bron) {
                    if (bron.type === 'Se75' || bron.type === 'Ir192') {
                        sourceSelect.value = bron.type;
                    }
                }
            }
        });

        async function laadBronnenCSV() {
            try {
                const response = await fetch('bronnen.csv');
                const csvText = await response.text();
                const rows = csvText.trim().split('\n').slice(1);
                rows.forEach(row => {
                    const columns = row.split(',');
                    if (columns.length >= 5) {
                        const bronNaam = columns[0].trim();
                        const bronType = columns[1].trim();
                        const bronGrootte = columns[4].trim();
                        if (bronNaam && bronGrootte) {
                            const label = `${bronNaam} (${bronGrootte} mm)`;
                            bronnenData.push({ name: bronNaam, type: bronType, size: parseFloat(bronGrootte), label: label });
                        }
                    }
                });
                updateBronGrootteOptions();
            } catch (error) {
                console.error("Kon bronnen.csv niet laden.", error);
            }
        }

        function createCrosshair(x, y) {
            const cross = document.createElement('div');
            cross.className = 'crosshair';
            cross.style.left = (x - 15) + 'px';
            cross.style.top = (y - 15) + 'px';
            const circle = document.createElement('div');
            circle.className = 'highlight-circle';
            cross.appendChild(circle);
            return cross;
        }

        function calculate() {
            calculateMinFFD();
            calculateResults();
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
        }

        function calculateResults() {
            const procedure = document.getElementById("procedure").value;
            const diameter = parseFloat(document.getElementById("diameter").value);
            const wanddikte = parseFloat(document.getElementById("wanddikte").value);
            const ofa = parseFloat(document.getElementById("ofa").value);
            let sfd = parseFloat(document.getElementById("sfd").value);
            const source = document.getElementById("source").value;
            const technique = document.getElementById("technique").value;
            const ovaaltje = document.getElementById("ovaaltje").value;
            const lasbreedte = parseFloat(document.getElementById("lasbreedte").value);

            const diameterWarningDiv = document.getElementById("diameter-warning");
            if (!isNaN(diameter) && diameter < 100 && (procedure === "EN-A" || procedure === "EN-B")) {
                if (technique !== "DWDI") {
                    diameterWarningDiv.textContent = "Waarschuwing: Bij een diameter kleiner dan 100 mm wordt aanbevolen om de DWDI opstelling te gebruiken.";
                    diameterWarningDiv.style.display = 'block';
                } else {
                    diameterWarningDiv.style.display = 'none';
                }
            } else {
                diameterWarningDiv.style.display = 'none';
            }

            const warningDiv = document.getElementById("ffd-result-warning");
            if (!isNaN(sfd) && !isNaN(minFFD) && sfd < minFFD) {
                warningDiv.textContent = `Je gekozen FFD is lager dan de minimale FFD: ${minFFD.toFixed(2)} mm`;
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }

            let wire = "Onbekend";
            if (procedure === "EN-B") {
                let doorstraaldeDikte = 2 * wanddikte;

                if (technique === "SWSI") {
                    if (wanddikte <= 1.5) wire = "W19";
                    else if (wanddikte <= 2.5) wire = "W18";
                    else if (wanddikte <= 4) wire = "W17";
                    else if (wanddikte <= 6) wire = "W16";
                    else if (wanddikte <= 8) wire = "W15";
                    else if (wanddikte <= 12) wire = "W14";
                    else if (wanddikte <= 20) wire = "W13";
                    else if (wanddikte <= 30) wire = "W12";
                    else if (wanddikte <= 35) wire = "W11";
                    else if (wanddikte <= 45) wire = "W10";
                    else if (wanddikte <= 65) wire = "W9";
                } else if (technique === "DWDI") {
                    if (doorstraaldeDikte <= 1.5) wire = "W19";
                    else if (doorstraaldeDikte <= 2.5) wire = "W18";
                    else if (doorstraaldeDikte <= 4) wire = "W17";
                    else if (doorstraaldeDikte <= 6) wire = "W16";
                    else if (doorstraaldeDikte <= 8) wire = "W15";
                    else if (doorstraaldeDikte <= 15) wire = "W14";
                    else if (doorstraaldeDikte <= 25) wire = "W13";
                    else if (doorstraaldeDikte <= 38) wire = "W12";
                    else if (doorstraaldeDikte <= 45) wire = "W11";
                    else if (doorstraaldeDikte <= 55) wire = "W10";
                    else if (doorstraaldeDikte <= 70) wire = "W9";
                } else if (technique === "DWSI") {
                    if (doorstraaldeDikte <= 1.5) wire = "W19";
                    else if (doorstraaldeDikte <= 2.5) wire = "W18";
                    else if (doorstraaldeDikte <= 4) wire = "W17";
                    else if (doorstraaldeDikte <= 6) wire = "W16";
                    else if (doorstraaldeDikte <= 12) wire = "W15";
                    else if (doorstraaldeDikte <= 18) wire = "W14";
                    else if (doorstraaldeDikte <= 30) wire = "W13";
                    else if (doorstraaldeDikte <= 45) wire = "W12";
                    else if (doorstraal
