<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gecombineerde Tool</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <a href="index.html" class="home-icon"><i class="fas fa-home"></i></a>
    <style>
        /* Add some styling to make the layout look good */
        .form-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 10px auto;
            max-width: 600px;
        }
        .form-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 10px; /* Added margin */
        }
        .form-item label {
            min-width: 200px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-item input,
        .form-item select {
            flex: 1;
            padding: 8px;
            width: 100%;
            min-width: 200px;
            box-sizing: border-box;
        }
        .submit-btn {
            background-color: #F5DF4D;
            color: black;
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            display: block;
            margin: 20px auto;
            width: 100%;
            max-width: 400px;
        }
        .image-container {
            position: relative;
            background-size: cover;
            border: 1px solid black;
            margin: 20px auto;
        }
        .crosshair {
            position: absolute;
            width: 30px;
            height: 30px;
            left: 0;
            top: 0;
            pointer-events: none;
        }

        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background-color: rgb(255, 49, 49);
        }

        .crosshair::before { top: 14px; left: 0; width: 30px; height: 2px; }
        .crosshair::after { left: 14px; top: 0; width: 2px; height: 30px; }

        .highlight-circle {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(0, 0, 128, 0.2);
            left: -10px;
            top: -10px;
            pointer-events: none;
        }
        #wire-result {
            color: yellow;
        }
        #container1A h2,
        #container2A h2,
        #container1B h2,
        #container2B h2 {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Gecombineerde Tool</h1>

    <div class="form-container">
        <div class="form-item">
            <label for="procedure">Kies de procedure:</label>
            <select id="procedure" name="procedure" required>
                <option value="" disabled selected>Selecteer procedure</option>
                <option value="EN-A">EN-Klasse A</option>
                <option value="EN-B">EN-Klasse B</option>
                <option value="ASME">ASME</option>
            </select>
        </div>
        <div class="form-item">
            <label for="diameter">Diameter (De) in mm:</label>
            <input type="number" id="diameter" name="diameter" step="0.01" required>
        </div>
        <div class="form-item">
            <label for="wanddikte">Wanddikte (t) in mm:</label>
            <input type="number" id="wanddikte" name="wanddikte" step="0.01" required>
        </div>
        <div id="enOptions" style="display:none;">
            <div class="form-item">
                <label for="technique">Opstelling:</label>
                <select id="technique" name="technique">
                    <option value="SWSI">SWSI</option>
                    <option value="DWSI">DWSI</option>
                    <option value="DWDI">DWDI</option>
                </select>
            </div>
            <div class="form-item">
                <label for="source">Stralingsbron:</label>
                <select id="source" name="source">
                    <option value="X-ray">X-ray</option>
                    <option value="Se75">Se-75</option>
                    <option value="Ir192">Ir-192</option>
                </select>
            </div>
             <div class="form-item" id="optieDiv" style="display:none;">
                <label for="optie">Centraal of Excentrisch:</label>
                <select id="optie" name="optie">
                    <option value="">Nee</option>
                    <option value="1">Centraal</option>
                    <option value="2">Excentrisch</option>
                </select>
            </div>
        </div>
        <div class="form-item">
            <label for="brongrootte">Brongrootte in mm:</label>
            <input type="text" id="brongrootte" name="brongrootte" list="bronKeuzes" required placeholder="Kies of vul in (mm)">
            <datalist id="bronKeuzes">
            </datalist>
        </div>
        <div class="form-item">
            <label for="ofa">Object Film Afstand (OFA) in mm:</label>
            <input type="number" id="ofa" name="ofa" step="0.01" required>
        </div>
        <div class="form-item">
            <label for="sfd">Bron Film Afstand (FFD) in mm:</label>
            <input type="number" id="sfd" name="sfd" step="0.01" required>
            <span id="ffd-warning" style="color: red; margin-left: 10px;"></span>
        </div>
        <div id="asmeOptions" style="display:none;">
            <div class="form-item">
                <label for="asmeTechnique">Plaats van de BKI:</label>
                <select id="asmeTechnique" name="asmeTechnique">
                    <option value="Sourceside">BKI bronzijde</option>
                    <option value="Filmside">BKI Filmzijde</option>
                </select>
            </div>
            <div class="form-item">
                <label for="weldType">Lastype:</label>
                <select id="weldType" name="weldType">
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
            </div>
        </div>

        <button type="button" class="submit-btn" onclick="calculate()">Bereken</button>
    </div>

    <h2>Resultaten</h2>
    <p id="wire-result"></p>

    <div id="diameterAntwoord" style="display: none; text-align: center; margin: 20px;">
        <strong style="font-size: 1.3em; color: yellow; padding: 15px;">
            Aantal opnames: 2 bij opstelling 11/F , 3 bij opstelling 12/G
        </strong>
    </div>

    <div class="image-container" id="container1B" style="display: none; width: 488px; height: 819px; background-image: url('klasseb2.png');">
      <h2>Opstelling 5/8/13/14 (Klasse B)</h2>
    </div>
    <div class="image-container" id="container2B" style="display: none; width: 488px; height: 823px; background-image: url('klasseb1.png');">
      <h2>Opstelling 2 (Klasse B)</h2>
    </div>
    <div class="image-container" id="container1A" style="display: none; width: 487px; height: 823px; background-image: url('opstelling13klassea.png');">
      <h2>Opstelling 5/8/13/14 (Klasse A)</h2>
    </div>
    <div class="image-container" id="container2A" style="display: none; width: 470px; height: 796px; background-image: url('opstelling2klassea.png');">
      <h2>Opstelling 2 (Klasse A)</h2>
    </div>

    <script>
        let bronnenData = [];
        let minFFD = 0;

        // Add event listeners to all relevant inputs
        ["procedure", "diameter", "wanddikte", "brongrootte", "ofa", "sfd", "technique", "source", "optie"].forEach(id => {
            document.getElementById(id).addEventListener("input", updateFFD);
        });
        
        document.getElementById("source").addEventListener("change", updateBronGrootteOptions);


        function updateBronGrootteOptions() {
            const source = document.getElementById("source").value;
            const bronKeuzesDatalist = document.getElementById("bronKeuzes");
            bronKeuzesDatalist.innerHTML = '';

            if (source === 'X-ray') {
                bronKeuzesDatalist.innerHTML = `
                    <option value="Yxlon (3 mm)"></option>
                    <option value="Yxlon Smart (1 mm)"></option>
                    <option value="Balteau (2.5 mm)"></option>
                `;
            } else {
                const filteredBronnen = bronnenData.filter(b => b.type === source);
                filteredBronnen.forEach(bron => {
                    const option = document.createElement('option');
                    option.value = bron.label;
                    bronKeuzesDatalist.appendChild(option);
                });
            }
        }

        function updateFFD() {
            const procedure = document.getElementById("procedure").value;
            const diameter = parseFloat(document.getElementById("diameter").value);
            const wanddikte = parseFloat(document.getElementById("wanddikte").value);
            const brongrootteValue = document.getElementById("brongrootte").value;
            const ofa = parseFloat(document.getElementById("ofa").value);
            const source = document.getElementById("source").value;
            const optie = document.getElementById("optie").value;
            const centraal = optie === '1';
            const excentrisch = optie === '2';

            let brongrootte = 0;
            if (brongrootteValue.includes("Yxlon (3 mm)")) brongrootte = 3;
            else if (brongrootteValue.includes("Yxlon Smart (1 mm)")) brongrootte = 1;
            else if (brongrootteValue.includes("Balteau (2.5 mm)")) brongrootte = 2.5;
            else {
                 const bron = bronnenData.find(b => b.label === brongrootteValue);
                 brongrootte = bron ? bron.size : parseFloat(brongrootteValue);
            }


            if (isNaN(diameter) || isNaN(wanddikte) || isNaN(brongrootte) || isNaN(ofa)) {
                return;
            }

            let ffd = 0;
            if (procedure === "ASME") {
                if (wanddikte < 50) ffd = (brongrootte * ofa) / 0.51 + ofa;
                else if (wanddikte < 75) ffd = (brongrootte * ofa) / 0.76 + ofa;
                else if (wanddikte <= 100) ffd = (brongrootte * ofa) / 1.02 + ofa;
                else {
                    document.getElementById("ffd-warning").innerText = "Wanddikte te groot voor ASME berekening.";
                    return;
                }
            } else { // EN-A or EN-B
                let factor = (procedure === "EN-A") ? 7.5 : 15;
                let basis = brongrootte * factor * Math.pow(ofa, 2 / 3);
                if (centraal) basis *= 0.5;
                if (excentrisch) basis *= 0.8;
                ffd = basis + ofa;
            }

            if (source === 'X-ray') {
                const xrayFFD = diameter + 150;
                ffd = Math.max(ffd, xrayFFD);
            }

            minFFD = ffd;
            document.getElementById("sfd").value = ffd.toFixed(2);
            
            const userFFD = parseFloat(document.getElementById("sfd").value);
            if (userFFD < minFFD) {
                document.getElementById("ffd-warning").innerText = `Waarschuwing: FFD is lager dan het minimum van ${minFFD.toFixed(2)} mm`;
            } else {
                document.getElementById("ffd-warning").innerText = "";
            }
        }


        // Show/hide options based on procedure
        document.getElementById("procedure").addEventListener("change", function() {
            var procedure = document.getElementById("procedure").value;
            if (procedure === "EN-A" || procedure === "EN-B") {
                document.getElementById("enOptions").style.display = "block";
                document.getElementById("asmeOptions").style.display = "none";
            } else { // ASME
                document.getElementById("enOptions").style.display = "none";
                document.getElementById("asmeOptions").style.display = "block";
            }
        });

        document.getElementById("technique").addEventListener("change", function() {
            const technique = this.value;
            const ofaInput = document.getElementById("ofa");
            const wanddikte = parseFloat(document.getElementById("wanddikte").value);
            const diameter = parseFloat(document.getElementById("diameter").value);
            const optieDiv = document.getElementById("optieDiv");

            if (technique === "SWSI" || technique === "DWSI") {
                ofaInput.value = wanddikte;
                ofaInput.readOnly = true;
            } else if (technique === "DWDI") {
                ofaInput.value = diameter;
                ofaInput.readOnly = true;
            } else {
                ofaInput.readOnly = false;
            }

            if (technique === "SWSI") {
                optieDiv.style.display = "flex";
            } else {
                optieDiv.style.display = "none";
            }
        });

        document.getElementById("brongrootte").addEventListener("input", function() {
            const selectedLabel = this.value;
            const sourceSelect = document.getElementById("source");
            
            if (selectedLabel.toLowerCase().includes('yxlon') || selectedLabel.toLowerCase().includes('balteau')) {
                sourceSelect.value = 'X-ray';
                return;
            }

            const bron = bronnenData.find(b => b.label === selectedLabel);

            if (bron) {
                if (bron.type === 'Se75' || bron.type === 'Ir192') {
                    sourceSelect.value = bron.type;
                }
            }
        });

        async function laadBronnenCSV() {
            try {
                const response = await fetch('bronnen.csv');
                const csvText = await response.text();
                const rows = csvText.trim().split('\n').slice(1);
                rows.forEach(row => {
                    const columns = row.split(',');
                    if (columns.length >= 5) {
                        const bronNaam = columns[0].trim();
                        const bronType = columns[1].trim();
                        const bronGrootte = columns[4].trim();
                        if (bronNaam && bronGrootte) {
                            const label = `${bronNaam} (${bronGrootte} mm)`;
                            bronnenData.push({ name: bronNaam, type: bronType, size: parseFloat(bronGrootte), label: label });
                        }
                    }
                });
                updateBronGrootteOptions();
            } catch (error) {
                console.error("Kon bronnen.csv niet laden.", error);
            }
        }
        
        function createCrosshair(x, y) {
            const cross = document.createElement('div');
            cross.className = 'crosshair';
            cross.style.left = (x - 15) + 'px';
            cross.style.top = (y - 15) + 'px';
            const circle = document.createElement('div');
            circle.className = 'highlight-circle';
            cross.appendChild(circle);
            return cross;
        }

        function calculate() {
            updateFFD();
            // Get all input values
            const procedure = document.getElementById("procedure").value;
            const diameter = parseFloat(document.getElementById("diameter").value);
            const wanddikte = parseFloat(document.getElementById("wanddikte").value);
            const ofa = parseFloat(document.getElementById("ofa").value);
            let sfd = parseFloat(document.getElementById("sfd").value);
            const source = document.getElementById("source").value;

            // --- 1. Calculate Required Wire ---
            let wire = "Onbekend";
            if (procedure === "EN-B") {
                const technique = document.getElementById("technique").value;
                let doorstraaldeDikte = 2 * wanddikte;

                if (technique === "SWSI") {
                    if (wanddikte <= 1.5) wire = "W19";
                    else if (wanddikte <= 2.5) wire = "W18";
                    else if (wanddikte <= 4) wire = "W17";
                    else if (wanddikte <= 6) wire = "W16";
                    else if (wanddikte <= 8) wire = "W15";
                    else if (wanddikte <= 12) wire = "W14";
                    else if (wanddikte <= 20) wire = "W13";
                    else if (wanddikte <= 30) wire = "W12";
                    else if (wanddikte <= 35) wire = "W11";
                    else if (wanddikte <= 45) wire = "W10";
                    else if (wanddikte <= 65) wire = "W9";
                } else if (technique === "DWDI") {
                    if (doorstraaldeDikte <= 1.5) wire = "W19";
                    else if (doorstraaldeDikte <= 2.5) wire = "W18";
                    else if (doorstraaldeDikte <= 4) wire = "W17";
                    else if (doorstraaldeDikte <= 6) wire = "W16";
                    else if (doorstraaldeDikte <= 8) wire = "W15";
                    else if (doorstraaldeDikte <= 15) wire = "W14";
                    else if (doorstraaldeDikte <= 25) wire = "W13";
                    else if (doorstraaldeDikte <= 38) wire = "W12";
                    else if (doorstraaldeDikte <= 45) wire = "W11";
                    else if (doorstraaldeDikte <= 55) wire = "W10";
                    else if (doorstraaldeDikte <= 70) wire = "W9";
                } else if (technique === "DWSI") {
                    if (doorstraaldeDikte <= 1.5) wire = "W19";
                    else if (doorstraaldeDikte <= 2.5) wire = "W18";
                    else if (doorstraaldeDikte <= 4) wire = "W17";
                    else if (doorstraaldeDikte <= 6) wire = "W16";
                    else if (doorstraaldeDikte <= 12) wire = "W15";
                    else if (doorstraaldeDikte <= 18) wire = "W14";
                    else if (doorstraaldeDikte <= 30) wire = "W13";
                    else if (doorstraaldeDikte <= 45) wire = "W12";
                    else if (doorstraaldeDikte <= 55) wire = "W11";
                    else if (doorstraaldeDikte <= 70) wire = "W10";
                }

                if (source === "Se75") {
                    if (technique === "SWSI"  && wanddikte >5 && wanddikte <= 20) {
                        wire = "W" + (parseInt(wire.substring(1)) - 1);
                    } else if (technique === "DWDI" && doorstraaldeDikte >5 &&  doorstraaldeDikte <= 12) {
                        wire = "W" + (parseInt(wire.substring(1)) - 1);
                    } else if (technique === "DWSI" && doorstraaldeDikte >5 && doorstraaldeDikte <= 20) {
                        wire = "W" + (parseInt(wire.substring(1))-1);
                    }
                } else if (source === "Ir192") {
                    if (technique === "SWSI" && wanddikte >= 10 && wanddikte <= 40) {
                        wire = "W" + (parseInt(wire.substring(1)) - 1);
                    } else if (technique === "DWDI" && doorstraaldeDikte > 10 && doorstraaldeDikte <= 25) {
                        wire = "W" + (parseInt(wire.substring(1)) - 1);
                    } else if (technique === "DWSI" && doorstraaldeDikte >10 && doorstraaldeDikte <= 40) {
                        wire = "W" + (parseInt(wire.substring(1)) - 1 );
                    }
                }
            } else if (procedure === "ASME") {
                const asmeTechnique = document.getElementById("asmeTechnique").value;
                const weldType = document.getElementById("weldType").value;
                
                let maxOverdikte = 0;
                if (weldType === "A" || weldType === "D") {
                    if (wanddikte <= 2.4) maxOverdikte = 0.8;
                    else if (wanddikte <= 4.8) maxOverdikte = 1.5;
                    else if (wanddikte <= 25) maxOverdikte = 2.5;
                    else maxOverdikte = 3;
                } else if (weldType === "B" || weldType === "C") {
                    if (wanddikte <= 2.4) maxOverdikte = 2.5;
                    else if (wanddikte <= 4.8) maxOverdikte = 3;
                    else if (wanddikte <= 13) maxOverdikte = 4;
                    else if (wanddikte <= 25) maxOverdikte = 5;
                    else maxOverdikte = 6;
                }
                const effectiveWanddikte = wanddikte + maxOverdikte;

                if (asmeTechnique === "Sourceside") {
                    if (effectiveWanddikte <= 6.4) wire = "EN W13,ASME 5";
                    else if (effectiveWanddikte <= 9.5) wire = "EN W12, ASME 6";
                    else if (effectiveWanddikte <= 12.7) wire = "EN W11, ASME 7";
                    else if (effectiveWanddikte <= 19) wire = "EN W10, ASME 8";
                    else if (effectiveWanddikte <= 25.4) wire = "EN W9, ASME 9";
                    else if (effectiveWanddikte <= 38.1) wire = "EN W8, ASME 10";
                    else if (effectiveWanddikte <= 50.8) wire = "EN W7, ASME 11";
                    else if (effectiveWanddikte <= 63.5) wire = "EN W6, ASME 12";
                    else wire = "EN W5, ASME 13";
                } else { // Film side
                    if (effectiveWanddikte <= 6.4) wire = "EN W14,ASME 4";
                    else if (effectiveWanddikte <= 9.5) wire = "EN W13, ASME 5";
                    else if (effectiveWanddikte <= 12.7) wire = "EN W12, ASME 6";
                    else if (effectiveWanddikte <= 19) wire = "EN W11, ASME 7";
                    else if (effectiveWanddikte <= 25.4) wire = "EN W10, ASME 8";
                    else if (effectiveWanddikte <= 38.1) wire = "EN W9, ASME 9";
                    else if (effectiveWanddikte <= 50.8) wire = "EN W8, ASME 10";
                    else if (effectiveWanddikte <= 63.5) wire = "EN W7, ASME 11";
                    else wire = "EN W6, ASME 12";
                }
            }
            document.getElementById("wire-result").innerText = "Vereist draadje: " + wire;

            // --- 3. Plot Exposures ---
            const technique = document.getElementById("technique").value;
            document.getElementById('container1A').style.display = 'none';
            document.getElementById('container2A').style.display = 'none';
            document.getElementById('container1B').style.display = 'none';
            document.getElementById('container2B').style.display = 'none';
            document.getElementById('diameterAntwoord').style.display = 'none';

            if (technique === "DWDI") {
                document.getElementById('diameterAntwoord').innerHTML = '<strong style="font-size: 1.3em; color: yellow; padding: 15px;">Aantal opnames: 2 (opstelling 11,F) of 3 (opstelling 12,G)</strong>';
                document.getElementById('diameterAntwoord').style.display = 'block';
                return;
            }

            if (diameter <= 100) {
                document.getElementById('diameterAntwoord').innerHTML = '<strong style="font-size: 1.3em; color: yellow; padding: 15px;">Aantal opnames: 2 bij opstelling 11/F , 3 bij opstelling 12/G</strong>';
                document.getElementById('diameterAntwoord').style.display = 'block';
                return;
            }

            const klasse = (procedure === 'EN-A' || procedure === 'ASME') ? 'A' : 'B';
            const t_plot = ofa;
            const De_plot = diameter;
            const SFD = sfd;

            const x_value1 = t_plot / De_plot;
            const y_value1 = De_plot / SFD;
            const x_value2 = t_plot / De_plot;
            const y_value2 = De_plot / (SFD - t_plot);

            let x_pixel1, y_pixel1, x_pixel2, y_pixel2, y_scale1, y_scale2;

            if (klasse === 'B') {
                x_pixel1 = (x_value1 / 0.25) * 488; y_pixel1 = (y_value1 / 2) * 819; y_scale1 = 819;
                x_pixel2 = (x_value2 / 0.25) * 488; y_pixel2 = (y_value2 / 4) * 823; y_scale2 = 823;
                document.getElementById('container1B').style.display = 'block';
                document.getElementById('container2B').style.display = 'block';
            } else { // Klasse A or ASME
                x_pixel1 = (x_value1 / 0.25) * 487; y_pixel1 = (y_value1 / 2) * 823; y_scale1 = 823;
                x_pixel2 = (x_value2 / 0.25) * 470; y_pixel2 = (y_value2 / 4) * 796; y_scale2 = 796;
                document.getElementById('container1A').style.display = 'block';
                document.getElementById('container2A').style.display = 'block';
            }

            const container1 = document.getElementById(`container1${klasse}`);
            const container2 = document.getElementById(`container2${klasse}`);

            container1.innerHTML = `<h2>Opstelling 5/8/13/14 (Klasse ${klasse})</h2>`;
            container1.appendChild(createCrosshair(x_pixel1, y_scale1 - y_pixel1));
            container2.innerHTML = `<h2>Opstelling 2 (Klasse ${klasse})</h2>`;
            container2.appendChild(createCrosshair(x_pixel2, y_scale2 - y_pixel2));
        }

        document.addEventListener('DOMContentLoaded', function() {
            laadBronnenCSV();
            document.getElementById("optieDiv").style.display = "none";
        });
    </script>
</body>
</html>
