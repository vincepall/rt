<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gevoelige Data Snipper PWA</title>
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        :root { --primary: #007bff; }
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        #canvas-wrapper { 
            position: relative; 
            margin-top: 20px; 
            border: 2px solid #ddd; 
            overflow: auto; 
            max-height: 70vh;
            background: #525659; /* PDF viewer look */
        }
        
        canvas { display: block; margin: 0 auto; cursor: crosshair; }
        
        #selection-rect { 
            position: absolute; 
            border: 2px solid var(--primary); 
            background: rgba(0, 123, 255, 0.2); 
            display: none; 
            pointer-events: none; 
        }

        .output-zone { 
            position: sticky; bottom: 20px; 
            background: white; border: 2px solid var(--primary); 
            padding: 15px; border-radius: 8px; margin-top: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .btn { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; }
        #status { font-size: 0.9em; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h2>Document Data Snipper</h2>
    <input type="file" id="file-upload" accept="image/*,application/pdf">
    <span id="status">Wacht op bestand...</span>

    <div id="canvas-wrapper">
        <canvas id="main-canvas"></canvas>
        <div id="selection-rect"></div>
    </div>

    <div class="output-zone">
        <div>
            <strong>Gescande Tekst:</strong>
            <div id="ocr-result" style="font-family: monospace; font-size: 1.2em; margin-top: 5px;">...</div>
        </div>
        <button class="btn" onclick="copyResult()">Kopieer</button>
    </div>
</div>

<script>
    // PDF.js instellen
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    const selectionRect = document.getElementById('selection-rect');
    const ocrResult = document.getElementById('ocr-result');
    const status = document.getElementById('status');

    let isDrawing = false;
    let startX, startY;

    // --- BESTANDSVERWERKING ---
    document.getElementById('file-upload').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        status.innerText = "Laden...";
        
        if (file.type === "application/pdf") {
            const arrayBuffer = await file.arrayBuffer();
            renderPDF(arrayBuffer);
        } else {
            const url = URL.createObjectURL(file);
            renderImage(url);
        }
    };

    function renderImage(url) {
        const img = new Image();
        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            status.innerText = "Foto geladen. Trek een kader.";
        };
        img.src = url;
    }

    async function renderPDF(data) {
        const pdf = await pdfjsLib.getDocument({data}).promise;
        const page = await pdf.getPage(1); // We pakken pagina 1
        const viewport = page.getViewport({scale: 2.0}); // Hoge kwaliteit scan
        
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        
        await page.render({canvasContext: ctx, viewport: viewport}).promise;
        status.innerText = "PDF geladen. Trek een kader.";
    }

    // --- SELECTIE LOGICA ---
    canvas.onmousedown = (e) => {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        startX = (e.clientX - rect.left) * (canvas.width / rect.width);
        startY = (e.clientY - rect.top) * (canvas.height / rect.height);
        selectionRect.style.display = 'block';
    };

    window.onmousemove = (e) => {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const currentX = (e.clientX - rect.left) * (canvas.width / rect.width);
        const currentY = (e.clientY - rect.top) * (canvas.height / rect.height);

        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

        // Visuele weergave van het kader
        const boxX = Math.min(e.pageX, startX * (rect.width / canvas.width) + rect.left + scrollLeft);
        const boxY = Math.min(e.pageY, startY * (rect.height / canvas.height) + rect.top + scrollTop);
        const boxW = Math.abs(currentX - startX) * (rect.width / canvas.width);
        const boxH = Math.abs(currentY - startY) * (rect.height / canvas.height);

        selectionRect.style.left = boxX + 'px';
        selectionRect.style.top = boxY + 'px';
        selectionRect.style.width = boxW + 'px';
        selectionRect.style.height = boxH + 'px';
    };

    window.onmouseup = async (e) => {
        if (!isDrawing) return;
        isDrawing = false;
        
        const rect = canvas.getBoundingClientRect();
        const endX = (e.clientX - rect.left) * (canvas.width / rect.width);
        const endY = (e.clientY - rect.top) * (canvas.height / rect.height);

        processCrop(startX, startY, endX - startX, endY - startY);
    };

    // --- OCR VERWERKING ---
    async function processCrop(x, y, w, h) {
        if (Math.abs(w) < 5 || Math.abs(h) < 5) return;

        ocrResult.innerText = "Scannen...";
        
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = Math.abs(w);
        tempCanvas.height = Math.abs(h);
        const tempCtx = tempCanvas.getContext('2d');
        
        tempCtx.drawImage(canvas, x, y, w, h, 0, 0, w, h);

        // Voer de OCR uit op het kleine stukje
        const result = await Tesseract.recognize(tempCanvas.toDataURL(), 'nld+eng');
        const text = result.data.text.trim();
        
        ocrResult.innerText = text || "[Geen tekst gevonden]";
        if (text) navigator.clipboard.writeText(text);
    }

    function copyResult() {
        navigator.clipboard.writeText(ocrResult.innerText);
        alert("Gekopieerd!");
    }
</script>

</body>
</html>
