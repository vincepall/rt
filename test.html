<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PWA Smart Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        /* CSS Variabelen voor makkelijke aanpassing */
        :root { --bg: #212529; --panel: #f8f9fa; --accent: #0d6efd; --border: #dee2e6; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; display: flex; flex-direction: column; height: 100vh; background: var(--bg); 
            overscroll-behavior: none; /* Voorkomt 'pull-to-refresh' op mobiel */
        }
        
        /* --- TOOLBAR --- */
        .toolbar { 
            background: var(--panel); padding: 10px; display: flex; gap: 10px; align-items: center; 
            border-bottom: 1px solid var(--border); z-index: 100; flex-wrap: wrap; 
        }
        .btn-group { display: flex; gap: 5px; }
        
        button { 
            padding: 8px 12px; cursor: pointer; background: #e9ecef; border: 1px solid #ced4da; 
            border-radius: 4px; font-weight: 600; font-size: 14px; 
        }
        button:active { background: #dde2e6; transform: translateY(1px); }
        button.primary { background: var(--accent); color: white; border-color: var(--accent); }
        
        /* --- VIEWPORT --- */
        .viewport { 
            flex: 1; overflow: auto; padding: 20px; 
            display: flex; align-items: flex-start; justify-content: flex-start; /* Fix voor scrollen */
            position: relative;
        }
        
        .canvas-wrapper { 
            position: relative; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
            background: white; touch-action: none; /* Cruciaal: voorkomt scrollen tijdens tekenen op mobiel */
        }
        
        canvas { display: block; max-width: none; }
        
        /* --- SELECTIE KADER --- */
        #selection-box { 
            position: absolute; border: 2px solid var(--accent); 
            background: rgba(13, 110, 253, 0.2); display: none; pointer-events: none; z-index: 50; 
        }

        /* --- FOOTER --- */
        .footer { 
            background: var(--panel); padding: 15px; border-top: 1px solid var(--border); 
            display: flex; gap: 10px; align-items: center; 
        }
        .result-box { 
            flex: 1; font-family: monospace; background: white; border: 1px solid var(--border); 
            padding: 10px; border-radius: 4px; font-size: 1.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        
        /* Mobiele aanpassing */
        @media (max-width: 600px) {
            .viewport { padding: 10px; }
            .toolbar { justify-content: space-between; }
            #file-input { width: 100%; margin-bottom: 5px; }
        }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="file" id="file-input" accept="image/*,application/pdf" style="font-size:0.9em;">
    <div class="btn-group">
        <button onclick="changePage(-1)" id="prev-btn" disabled>❮</button>
        <span id="page-indicator" style="padding: 5px; font-size: 0.9em; align-self: center;">-</span>
        <button onclick="changePage(1)" id="next-btn" disabled>❯</button>
    </div>
    <button onclick="rotateDocument()">↻ Draai</button>
</div>

<div class="viewport" id="viewport">
    <div class="canvas-wrapper" id="wrapper">
        <canvas id="main-canvas"></canvas>
        <div id="selection-box"></div>
    </div>
</div>

<div class="footer">
    <div class="result-box" id="ocr-result">Selecteer tekst...</div>
    <button class="primary" onclick="copyText()">KOPIEER</button>
</div>

<script>
    // PDF.js instellen (gebruikt CDN voor demo, download lokaal voor offline PWA)
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    // State Variabelen
    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let rotation = 0;
    let scale = 2.5; // Hoge kwaliteit voor OCR
    let currentImage = null; // Als het een foto is ipv PDF

    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    const wrapper = document.getElementById('wrapper');
    const selectionBox = document.getElementById('selection-box');
    const ocrResult = document.getElementById('ocr-result');

    // --- BESTAND LADEN ---
    document.getElementById('file-input').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        resetState();
        
        if (file.type === "application/pdf") {
            const arrayBuffer = await file.arrayBuffer();
            pdfDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            document.getElementById('page-indicator').innerText = `1 / ${pdfDoc.numPages}`;
            updatePaginationButtons();
            renderPage(pageNum);
        } else {
            // Het is een afbeelding
            const img = new Image();
            img.onload = () => {
                currentImage = img;
                renderImage();
            };
            img.src = URL.createObjectURL(file);
            document.getElementById('page-indicator').innerText = "IMG";
        }
    };

    function resetState() {
        pdfDoc = null;
        currentImage = null;
        pageNum = 1;
        rotation = 0;
        selectionBox.style.display = 'none';
        ocrResult.innerText = "Selecteer tekst...";
    }

    // --- RENDERING ---
    async function renderPage(num) {
        pageRendering = true;
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale: scale, rotation: rotation });
        
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        updateWrapperSize();

        await page.render({ canvasContext: ctx, viewport: viewport }).promise;
        pageRendering = false;
        document.getElementById('page-indicator').innerText = `${num} / ${pdfDoc.numPages}`;
    }

    function renderImage() {
        if (!currentImage) return;
        const isRotated = rotation % 180 !== 0;
        
        canvas.width = isRotated ? currentImage.height : currentImage.width;
        canvas.height = isRotated ? currentImage.width : currentImage.height;
        updateWrapperSize();

        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.rotate(rotation * Math.PI / 180);
        ctx.drawImage(currentImage, -currentImage.width/2, -currentImage.height/2);
        ctx.restore();
    }

    function updateWrapperSize() {
        wrapper.style.width = canvas.width + "px";
        wrapper.style.height = canvas.height + "px";
    }

    // --- NAVIGATIE & ROTATIE ---
    function changePage(offset) {
        if (!pdfDoc || pageRendering) return;
        const newPage = pageNum + offset;
        if (newPage >= 1 && newPage <= pdfDoc.numPages) {
            pageNum = newPage;
            renderPage(pageNum);
            updatePaginationButtons();
        }
    }

    function updatePaginationButtons() {
        if(!pdfDoc) return;
        document.getElementById('prev-btn').disabled = pageNum <= 1;
        document.getElementById('next-btn').disabled = pageNum >= pdfDoc.numPages;
    }

    function rotateDocument() {
        rotation = (rotation + 90) % 360;
        if (pdfDoc) renderPage(pageNum);
        else renderImage();
    }

    // --- SELECTIE LOGICA (MUIS + TOUCH) ---
    let isDrawing = false;
    let startX, startY;

    // Helper om positie te berekenen onafhankelijk van muis of touch
    function getPointerPos(e) {
        const rect = wrapper.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    function startDraw(e) {
        if (e.target !== canvas && e.target !== selectionBox) return;
        // Bij touch events, voorkom dat de browser gaat scrollen
        if(e.type === 'touchstart') document.body.style.overflow = 'hidden'; 
        
        isDrawing = true;
        const pos = getPointerPos(e);
        startX = pos.x;
        startY = pos.y;
        
        selectionBox.style.display = 'block';
        selectionBox.style.width = '0px';
        selectionBox.style.height = '0px';
    }

    function moveDraw(e) {
        if (!isDrawing) return;
        e.preventDefault(); // Voorkom scrollen tijdens slepen

        const pos = getPointerPos(e);
        const currentX = pos.x;
        const currentY = pos.y;

        const width = currentX - startX;
        const height = currentY - startY;

        selectionBox.style.width = Math.abs(width) + 'px';
        selectionBox.style.height = Math.abs(height) + 'px';
        selectionBox.style.left = (width < 0 ? currentX : startX) + 'px';
        selectionBox.style.top = (height < 0 ? currentY : startY) + 'px';
    }

    function endDraw(e) {
        if (!isDrawing) return;
        isDrawing = false;
        document.body.style.overflow = ''; // Scrollen weer aanzetten

        // OCR Uitvoeren
        const rect = selectionBox.getBoundingClientRect();
        const wrapperRect = wrapper.getBoundingClientRect();
        
        // Bereken positie relatief aan canvas resolutie
        const x = rect.left - wrapperRect.left;
        const y = rect.top - wrapperRect.top;
        const w = rect.width;
        const h = rect.height;

        if (w > 5 && h > 5) {
            doOCR(x, y, w, h);
        }
    }

    // Event Listeners Muis
    wrapper.addEventListener('mousedown', startDraw);
    window.addEventListener('mousemove', moveDraw);
    window.addEventListener('mouseup', endDraw);

    // Event Listeners Touch (Mobiel)
    wrapper.addEventListener('touchstart', startDraw, {passive: false});
    window.addEventListener('touchmove', moveDraw, {passive: false});
    window.addEventListener('touchend', endDraw);


    // --- OCR VERWERKING ---
    async function doOCR(x, y, w, h) {
        ocrResult.innerText = "⏳ Bezig met scannen...";
        ocrResult.style.color = "#666";
        
        try {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = w;
            tempCanvas.height = h;
            const tCtx = tempCanvas.getContext('2d');
            
            tCtx.drawImage(canvas, x, y, w, h, 0, 0, w, h);

            const result = await Tesseract.recognize(tempCanvas.toDataURL(), 'nld+eng');
            const cleanText = result.data.text.trim().replace(/\n/g, ' ');
            
            ocrResult.innerText = cleanText || "(Geen tekst herkend)";
            ocrResult.style.color = "#000";
            
            // Optioneel: Automatisch kopiëren
            if (cleanText) navigator.clipboard.writeText(cleanText);
            
        } catch (err) {
            ocrResult.innerText = "Fout bij scannen";
            console.error(err);
        }
    }

    function copyText() {
        const text = ocrResult.innerText;
        if(text && text !== "..." && text !== "Selecteer tekst...") {
            navigator.clipboard.writeText(text);
            const originalBtnText = document.querySelector('.primary').innerText;
            document.querySelector('.primary').innerText = "✔";
            setTimeout(() => document.querySelector('.primary').innerText = originalBtnText, 1000);
        }
    }
</script>

</body>
</html>
